<!DOCTYPE html>
<!-- Version: 1.2.0 - Production Ready (Supabase + Active Filter Fix) -->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Tracker | Platform Development & Integration</title>
    
    <!-- Supabase JS Client - Required for cloud storage -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS Variables */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #334155;
            --bg-hover: #475569;
            --bg-accent: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --text-on-gradient: #ffffff;
            --accent-color: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.5);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --risk-color: #f97316;
            --border-color: #e2e8f0;
            --purple: #8b5cf6;
            --radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            /* Timeline-specific variables */
            --timeline-lane-height: 24px;
            --timeline-bar-height: 20px;
            --timeline-lane-gap: 4px;
            --timeline-lane-separator: rgba(100, 116, 139, 0.15);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Layout & Components */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-nav {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            display: flex;
            align-items: center;
            padding: 0 2.5rem;
            z-index: 100;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.04);
            gap: 3rem;
            position: relative;
        }
        
        .top-nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            opacity: 0.8;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            white-space: nowrap;
            padding: 1rem 0;
        }
        
        .app-title-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .app-title-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .app-title h1 {
            color: #667eea; /* Fallback color for browsers that don't support background-clip */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .app-title .subtitle {
            color: var(--text-secondary);
            font-size: 0.813rem;
            font-weight: 500;
            margin: 0;
            letter-spacing: 0.01em;
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 1.5rem 1.75rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            border-bottom: 3px solid transparent;
            gap: 0.625rem;
            font-weight: 600;
            font-size: 0.938rem;
            letter-spacing: -0.01em;
            position: relative;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item:hover {
            color: var(--text-primary);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            transform: translateY(-1px);
        }
        
        .nav-item:hover .nav-icon {
            transform: scale(1.1);
        }

        .nav-item.active {
            color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
            border-bottom-color: transparent;
        }
        
        .nav-item.active::before {
            transform: scaleX(1);
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            fill: currentColor;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            max-width: 100%;
            overflow-y: auto;
        }

        header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 2rem;
            gap: 0.5rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin: 0;
        }

        header .subtitle {
            font-size: 1.25rem;
            font-weight: 400;
            color: var(--text-on-gradient);
            opacity: 0.9;
            margin: 0;
        }

        h1,
        h2,
        h3 {
            margin: 0;
        }

        .btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-accent);
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 25px 30px -5px rgb(0 0 0 / 0.15);
        }

        /* Dashboard Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--card-accent, var(--accent-color)), transparent);
        }

        .metric-card h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-card.clickable {
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .metric-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 30px -5px rgb(0 0 0 / 0.2);
        }
        
        /* Individual stat card colors */
        #filter-all { --card-accent: var(--accent-color); }
        #filter-completed { --card-accent: var(--success-color); }
        #filter-active { --card-accent: var(--purple); }
        #filter-planned { --card-accent: var(--text-secondary); }
        #filter-risk { --card-accent: var(--risk-color); }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            table-layout: fixed;
        }

        th,
        td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Dashboard column width adjustments for better readability */
        #header-id {
            width: 8%;
        }

        #header-name {
            width: 35%;
        }

        #header-owner {
            width: 15%;
        }

        #header-keyInitiative {
            width: 10%;
        }

        #header-targetDate {
            width: 15%;
        }

        #header-status {
            width: 12%;
        }

        th {
            color: var(--text-muted);
            font-weight: normal;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
            position: relative;
        }

        th.sortable:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: white;
        }

        th.sortable::after {
            content: '‚Üï';
            font-size: 0.7rem;
            margin-left: 0.5rem;
            color: var(--text-muted);
            opacity: 0.3;
        }

        th.sortable.asc::after {
            content: '‚Üë';
            opacity: 1;
            color: var(--accent-color);
        }

        th.sortable.desc::after {
            content: '‚Üì';
            opacity: 1;
            color: var(--accent-color);
        }

        tr.clickable:hover {
            background-color: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }

        tr.key-initiative {
            border-left: 4px solid var(--warning-color);
            background: linear-gradient(90deg, rgba(234, 179, 8, 0.05) 0%, transparent 100%);
        }

        tr.key-initiative:hover {
            background: linear-gradient(90deg, rgba(234, 179, 8, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 99px;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: bold;
            border: 1px solid transparent;
        }

        .badge.active {
            background: rgba(14, 165, 233, 0.2);
            color: var(--accent-color);
            border-color: rgba(14, 165, 233, 0.3);
        }

        .badge.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success-color);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .badge.risk {
            background: rgba(249, 115, 22, 0.2);
            color: var(--risk-color);
            border-color: rgba(249, 115, 22, 0.3);
        }

        .badge.planned {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
            border-color: rgba(148, 163, 184, 0.3);
        }

        /* Tags */
        .tag-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            display: inline-block;
            margin-right: 4px;
            margin-top: 4px;
        }

        /* Timeline */
        .timeline-container {
            position: relative;
            margin-top: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            user-select: none;
        }

        .timeline-axis {
            position: relative;
            height: 28px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 0.75rem;
            min-width: 800px;
            margin-left: 150px;
            width: calc(100% - 150px);
            background: linear-gradient(to bottom, transparent 80%, rgba(0, 0, 0, 0.02) 100%);
        }

        .timeline-row {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            min-width: 800px;
            padding: 0.25rem 0;
        }

        .timeline-label {
            width: 150px;
            flex-shrink: 0;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0.5rem 1rem 0.5rem 0;
            position: sticky;
            left: 0;
            background: var(--bg-secondary);
            z-index: 10;
            color: var(--text-primary);
        }

        .timeline-track {
            flex-grow: 1;
            min-height: 30px;
            background: 
                repeating-linear-gradient(
                    to bottom,
                    var(--bg-primary) 0,
                    var(--bg-primary) var(--timeline-lane-height),
                    var(--timeline-lane-separator) var(--timeline-lane-height),
                    var(--timeline-lane-separator) calc(var(--timeline-lane-height) + 1px),
                    var(--bg-primary) calc(var(--timeline-lane-height) + 1px)
                );
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2px;
        }

        .timeline-bar {
            position: absolute;
            height: 20px;
            border-radius: 6px;
            opacity: 0.92;
            z-index: 5;
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
            padding: 0 6px;
        }

        .timeline-bar:hover {
            opacity: 1;
            z-index: 10;
            cursor: grab;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
            border-color: rgba(0, 0, 0, 0.3);
        }

        .timeline-bar.dragging {
            opacity: 0.95;
            z-index: 20;
            cursor: grabbing;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            transform: scale(1.03) translateY(-2px);
            border-color: rgba(0, 0, 0, 0.3);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            width: 800px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        input,
        select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 4px;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            outline: 2px solid var(--accent-color);
            border-color: transparent;
        }

        input[type="color"] {
            padding: 0;
            width: 40px;
            height: 38px;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        /* Category Pills */
        .category-pills {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .category-pill {
            padding: 0.4rem 0.8rem;
            border-radius: 99px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-pill:hover {
            border-color: var(--accent-color);
            color: var(--text-primary);
        }

        .category-pill.active {
            background: rgba(14, 165, 233, 0.2);
            border-color: var(--accent-color);
            color: white;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.2);
        }

        .category-pill .count {
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Multi-Select Tags/Categories */
        .multi-select-container {
            position: relative;
            width: 100%;
        }

        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 42px;
            cursor: text;
        }

        .selected-items:focus-within {
            outline: 2px solid var(--accent-color);
            border-color: transparent;
        }

        .selected-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-primary);
        }

        .selected-item .remove {
            cursor: pointer;
            color: var(--text-muted);
            font-weight: bold;
            padding: 0 0.25rem;
        }

        .selected-item .remove:hover {
            color: var(--risk-color);
        }

        .multi-select-input {
            flex: 1;
            min-width: 120px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            outline: none;
            padding: 0.25rem;
            font-family: inherit;
            font-size: 0.875rem;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-top: 0.25rem;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .multi-select-option {
            padding: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.875rem;
        }

        .multi-select-option:hover {
            background: var(--bg-hover);
        }

        .multi-select-option.selected {
            background: rgba(14, 165, 233, 0.1);
            color: var(--accent-color);
        }

        /* Date Input Styling */
        input[type="date"] {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        input[type="date"]:hover {
            border-color: var(--accent-color);
            background: var(--bg-primary);
        }

        input[type="date"]:focus {
            outline: none;
            border-color: var(--accent-color);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5) sepia(1) saturate(5) hue-rotate(190deg);
        }

        .phase-input {
            box-sizing: border-box;
            width: 100%;
        }
        
        table td {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        table select {
            box-sizing: border-box;
        }
        
        input[type="date"].error {
            border-color: var(--danger-color);
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Phase date labels */
        .phase-date-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 2px;
            font-weight: 500;
        }

        /* ========== PRODUCTION STYLES ========== */
        .production-banner {
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .storage-indicator {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .storage-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        .status-pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px currentColor;
        }

        .status-pulse.warning {
            background: var(--warning-color);
        }

        .status-pulse.error {
            background: var(--danger-color);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .production-banner.local {
            background: linear-gradient(90deg, #eab308 0%, #ca8a04 100%);
        }

        .production-banner.error {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Design 1: Initiatives & Content Grid */
        .dashboard-content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .initiatives-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-xl);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-accent);
            padding: 0.25rem;
            border-radius: 10px;
        }
        
        .filter-tab {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .filter-tab:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .filter-tab.active {
            background: var(--bg-secondary);
            color: var(--accent-color);
            box-shadow: var(--shadow-sm);
        }
        
        /* Initiative Items */
        .initiative-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .initiative-item {
            background: var(--bg-accent);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .initiative-item:hover {
            background: var(--bg-primary);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        
        .initiative-content {
            flex: 1;
        }
        
        .initiative-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .initiative-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-primary);
            flex-wrap: wrap;
        }
        
        .initiative-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .initiative-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .badge-active {
            background: rgba(139, 92, 246, 0.1);
            color: var(--purple);
        }
        
        .badge-planned {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
        }
        
        .badge-risk {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        
        .badge-completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        /* Progress Bar */
        .initiative-progress {
            margin-top: 0.5rem;
            height: 4px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .initiative-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--purple));
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        
        .initiative-progress-bar.completed {
            background: var(--success-color);
        }
        
        .initiative-progress-bar.risk {
            background: var(--risk-color);
        }
        
        /* Lifecycle Stage Badge */
        .lifecycle-stage {
            display: inline-block;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(139, 92, 246, 0.15);
            color: var(--purple);
            border: 1px solid rgba(139, 92, 246, 0.3);
            margin-left: 0.25rem;
        }
        
        /* Phase Info */
        .phase-info {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        /* Pagination Controls */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding: 1rem;
        }
        
        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-accent);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--bg-primary);
            border-color: var(--purple);
            color: var(--purple);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background: var(--purple);
            color: white;
            border-color: var(--purple);
        }
        
        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding: 0 1rem;
        }
        
        /* Sidebar Components */
        .dashboard-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .sidebar-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
        }
        
        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.25rem;
        }
        
        /* Upcoming Milestones */
        .timeline-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .timeline-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .timeline-date {
            flex-shrink: 0;
            width: 50px;
            font-weight: 700;
            color: var(--accent-color);
            font-size: 0.875rem;
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.9375rem;
        }
        
        .timeline-detail {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }
        
        /* Recent Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .activity-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem 0;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }
        
        .activity-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Notes Section for At Risk Initiatives */
        .notes-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .note-item {
            background: var(--bg-accent);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--risk-color);
        }
        
        .note-text {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9375rem;
        }
        
        .note-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .note-input-container {
            display: flex;
            gap: 0.5rem;
        }
        
        .note-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9375rem;
        }
        
        .note-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <!-- Production Status Banner -->
    <div class="production-banner" id="production-status">
        <span id="status-icon">‚òÅÔ∏è</span>
        <span id="status-text">Initializing...</span>
    </div>

    <!-- Storage Status Indicator -->
    <div class="storage-indicator" id="storage-indicator">
        <div class="status-pulse" id="status-pulse"></div>
        <span id="storage-text">Checking connection...</span>
    </div>

    <div class="app-shell">
        <nav class="top-nav">
            <div class="app-title">
                <div class="app-title-icon" role="img" aria-label="Portfolio dashboard icon">üìä</div>
                <div class="app-title-text">
                    <h1>Portfolio Tracker</h1>
                    <div class="subtitle">Platform Development & Integration</div>
                </div>
            </div>
            <div class="nav-tabs">
                <div class="nav-item active" id="btn-view-current" onclick="switchView('current')" title="Dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                    </svg>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" id="btn-view-timeline" onclick="switchView('timeline')" title="Timeline">
                    <svg class="nav-icon" viewBox="0 0 24 24">
                        <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                    </svg>
                    <span>Timeline</span>
                </div>
                <div class="nav-item" id="btn-view-snapshots" onclick="switchView('snapshots')" title="History">
                    <svg class="nav-icon" viewBox="0 0 24 24">
                        <path
                            d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z" />
                    </svg>
                    <span>History</span>
                </div>
            </div>
            <div class="nav-item" id="btn-settings-sidebar" onclick="openSettings()" title="Settings">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path
                        d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
                <span>Data</span>
            </div>
        </nav>

        <div class="app-container">
            <!-- Current View -->
            <div id="view-current">
                <div class="metrics-grid">
                    <div class="card metric-card" id="filter-all">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                        <h3>Total Initiatives</h3>
                        <div class="value" id="m-total">0</div>
                    </div>
                    <div class="card metric-card" style="border-top: 3px solid var(--purple)">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíØ</div>
                        <h3>Health Score</h3>
                        <div class="value" style="color:var(--purple)" id="m-health">-</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;" id="m-health-label">Calculating...</div>
                    </div>
                    <div class="card metric-card" id="filter-completed"
                        style="border-top: 3px solid var(--success-color)">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                        <h3>Completed</h3>
                        <div class="value" style="color:var(--success-color)" id="m-completed">0</div>
                    </div>
                    <div class="card metric-card" id="filter-active"
                        style="border-top: 3px solid var(--accent-color)">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöÄ</div>
                        <h3>Active</h3>
                        <div class="value" style="color:var(--accent-color)" id="m-active">0</div>
                    </div>
                    <div class="card metric-card" id="filter-planned"
                        style="border-top: 3px solid var(--text-secondary)">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
                        <h3>Planned</h3>
                        <div class="value" style="color:var(--text-secondary)" id="m-planned">0</div>
                    </div>
                    <div class="card metric-card" id="filter-risk"
                        style="border-top: 3px solid var(--risk-color)">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                        <h3>At Risk</h3>
                        <div class="value" style="color:var(--risk-color)" id="m-risk">0</div>
                    </div>
                </div>
                
                <!-- Portfolio Summary Section (Executive View) -->
                <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">üìà</span>
                        Portfolio Summary
                    </h3>
                    <div id="portfolio-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- Summary items injected by JS -->
                    </div>
                </div>

                <!-- Design 1: Initiatives and Sidebar -->
                <div class="dashboard-content-grid">
                    <!-- Initiatives Card -->
                    <div class="initiatives-card">
                        <div class="card-header">
                            <h2 class="card-title">Initiatives</h2>
                            <div class="filter-tabs">
                                <button class="filter-tab active" onclick="filterInitiatives('all')">All</button>
                                <button class="filter-tab" onclick="filterInitiatives('active')">Active</button>
                                <button class="filter-tab" onclick="filterInitiatives('planned')">Planned</button>
                                <button class="filter-tab" onclick="filterInitiatives('risk')">At Risk</button>
                            </div>
                        </div>
                        <!-- Category Filters -->
                        <div class="category-pills" id="category-filters"
                            style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-accent); border-radius: var(--radius-md);">
                            <!-- Pills injected by JS -->
                        </div>
                        <div class="initiative-list" id="initiative-list">
                            <!-- Initiative items populated by JavaScript -->
                        </div>
                        <!-- Pagination Controls -->
                        <div class="pagination-controls" id="initiatives-pagination">
                            <!-- Pagination buttons populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Sidebar with Upcoming Milestones and Recent Activity -->
                    <div class="dashboard-sidebar">
                        <!-- Upcoming Milestones -->
                        <div class="sidebar-card">
                            <h3 class="sidebar-title">Upcoming Milestones</h3>
                            <div id="upcoming-milestones">
                                <!-- Milestones populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Recent Activity (from Design 3) -->
                        <div class="sidebar-card">
                            <h3 class="sidebar-title">Recent Activity</h3>
                            <div class="activity-feed" id="recent-activity">
                                <!-- Activity items populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Timeline View -->
            <div id="view-timeline" class="hidden" style="margin-top: 2rem;">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                        <h2>Timeline</h2>
                        <button class="btn btn-danger" style="font-size:0.7rem; padding:4px 8px;"
                            onclick="clearTimelineFilters()">Reset Filters</button>
                    </div>

                    <!-- Timeline Filters -->
                    <div class="form-grid"
                        style="grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md);">
                        <div class="form-group">
                            <label style="font-size: 0.85rem; font-weight: 600;">&nbsp;</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="filter-tl-key" 
                                    onchange="updateTimelineFilters('key', this.checked)" 
                                    style="width: 18px; height: 18px; cursor: pointer;" />
                                <span style="font-size: 0.85rem;">Key initiatives only</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85rem; font-weight: 600;">Name</label>
                            <input type="text" id="filter-tl-name" placeholder="Filter by name..."
                                style="font-size: 0.875rem; padding: 0.5rem;"
                                oninput="updateTimelineFilters('name', this.value)">
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85rem; font-weight: 600;">Owner</label>
                            <input type="text" id="filter-tl-owner" placeholder="Filter by owner..."
                                style="font-size: 0.875rem; padding: 0.5rem;"
                                oninput="updateTimelineFilters('owner', this.value)">
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85rem; font-weight: 600;">Status</label>
                            <div id="filter-tl-status" style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" value="planned" onchange="updateTimelineStatusFilter()" style="width: 16px; height: 16px; cursor: pointer;" />
                                    <span>Planned</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" value="active" onchange="updateTimelineStatusFilter()" style="width: 16px; height: 16px; cursor: pointer;" />
                                    <span>Active</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" value="risk" onchange="updateTimelineStatusFilter()" style="width: 16px; height: 16px; cursor: pointer;" />
                                    <span>Risk</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" value="completed" onchange="updateTimelineStatusFilter()" style="width: 16px; height: 16px; cursor: pointer;" />
                                    <span>Completed</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85rem; font-weight: 600;">Before Date</label>
                            <input type="date" id="filter-tl-date" style="font-size: 0.875rem; padding: 0.5rem;"
                                onchange="updateTimelineFilters('targetDate', this.value)">
                        </div>
                    </div>

                    <div style="margin-bottom:0.5rem; font-size:0.8rem; color:var(--text-muted);">Tip: Drag phases to
                        reschedule. Click empty space to add new.</div>
                    <div class="timeline-container">
                        <div class="timeline-axis" id="timeline-axis"></div>
                        <div id="timeline-rows"></div>
                    </div>
                </div>
            </div>

            <!-- Snapshots View -->
            <div id="view-snapshots" class="hidden">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 1rem;">
                        <h2>History</h2>
                        <div style="display:flex; gap:0.5rem;">
                            <input type="text" id="snap-note" placeholder="Snapshot Note"
                                style="background:var(--bg-primary); border:1px solid var(--border-color); color:white; padding:0.5rem; border-radius:4px;">
                            <button class="btn btn-primary" onclick="takeSnapshot()">Take Snapshot</button>
                        </div>
                    </div>
                    <div id="snapshot-list" style="display:flex; gap:0.5rem; flex-wrap:wrap;"></div>
                </div>

                <div id="snapshot-preview" class="card hidden"
                    style="margin-top:2rem; border: 2px dashed var(--accent-color);">
                    <h3 style="color: var(--accent-color)">Snapshot Preview</h3>
                    <p id="preview-meta" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>

                    <div class="metrics-grid">
                        <div class="card metric-card">
                            <h3>Total</h3>
                            <div class="value" id="s-total">-</div>
                        </div>
                        <div class="card metric-card">
                            <h3>Completed</h3>
                            <div class="value" id="s-completed">-</div>
                        </div>
                        <div class="card metric-card">
                            <h3>Active</h3>
                            <div class="value" id="s-active">-</div>
                        </div>
                        <div class="card metric-card">
                            <h3>Risk</h3>
                            <div class="value" id="s-risk">-</div>
                        </div>
                    </div>

                    <!-- Historical Data Table -->
                    <div style="margin-top: 2rem;">
                        <h3>Snapshot Data Details</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phases & Dates</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="snapshot-table-body"></tbody>
                        </table>
                    </div>

                    <!-- Historical Timeline -->
                    <div style="margin-top: 2rem;">
                        <h3>Snapshot Timeline</h3>
                        <div class="timeline-container">
                            <div class="timeline-axis" id="snapshot-timeline-axis"></div>
                            <div id="snapshot-timeline-rows"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="modal-wrapper" class="modal-overlay hidden">
            <div class="modal-content card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Initiative Details</h2>
                    <button class="btn" onclick="closeModal()" aria-label="Close modal" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border-radius: 50%;">‚úï</button>
                </div>

                <!-- Editable Fields -->
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="edit-name">
                    </div>
                    <div class="form-group">
                        <label>Owner</label>
                        <input type="text" id="edit-owner">
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="edit-start">
                    </div>
                    <div class="form-group">
                        <label>Target Date</label>
                        <input type="date" id="edit-target">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="edit-status">
                            <option value="planned">Planned</option>
                            <option value="active">Active</option>
                            <option value="risk">Risk</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Categories</label>
                        <div class="multi-select-container" id="categories-multiselect">
                            <div class="selected-items" onclick="focusCategoriesInput()">
                                <input type="text" class="multi-select-input" id="categories-input"
                                    placeholder="Type to add or select..."
                                    oninput="filterCategoriesDropdown(this.value)"
                                    onkeydown="handleCategoriesKeydown(event)" onfocus="showCategoriesDropdown()"
                                    onblur="hideCategoriesDropdown()">
                            </div>
                            <div class="multi-select-dropdown hidden" id="categories-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tags</label>
                        <div class="multi-select-container" id="tags-multiselect">
                            <div class="selected-items" onclick="focusTagsInput()">
                                <input type="text" class="multi-select-input" id="tags-input"
                                    placeholder="Type to add or select..." oninput="filterTagsDropdown(this.value)"
                                    onkeydown="handleTagsKeydown(event)" onfocus="showTagsDropdown()"
                                    onblur="hideTagsDropdown()">
                            </div>
                            <div class="multi-select-dropdown hidden" id="tags-dropdown"></div>
                        </div>
                    </div>
                </div>

                <hr style="border-color: var(--border-color); width: 100%;">

                <!-- Notes Section for At Risk Initiatives -->
                <div id="notes-section" class="notes-section" style="display: none;">
                    <div class="notes-header">
                        <h3>Notes & Comments</h3>
                    </div>
                    <div class="notes-list" id="notes-list">
                        <!-- Notes will be populated by JavaScript -->
                    </div>
                    <div class="note-input-container">
                        <input type="text" id="note-input" class="note-input" placeholder="Add a note or comment...">
                        <button class="btn btn-primary" onclick="addNote()">Add Note</button>
                    </div>
                </div>

                <hr style="border-color: var(--border-color); width: 100%;">

                <!-- Phases -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Project Phases</h3>
                    <button class="btn btn-sm btn-primary" onclick="addPhase()">+ Add Phase</button>
                </div>

                <table style="margin-top: 0; table-layout: fixed; width: 100%;">
                    <thead>
                        <tr>
                            <th style="padding: 0.5rem; width: 22%; text-align: left;">Phase Name</th>
                            <th style="padding: 0.5rem; width: 8%; text-align: center;">Color</th>
                            <th style="padding: 0.5rem; width: 40%; text-align: left;">Dates (Start ‚Üí End)</th>
                            <th style="padding: 0.5rem; width: 18%; text-align: left;">Status</th>
                            <th style="padding: 0.5rem; width: 12%; text-align: center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="phases-list">
                        <!-- Phases injected here -->
                    </tbody>
                </table>

                <!-- Actions -->
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveContext()">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Jira Settings Modal -->
        <div id="settings-modal" class="modal-overlay hidden">
            <div class="modal-content card" style="width: 500px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Jira Data Source</h2>
                    <button class="btn" onclick="closeSettings()" aria-label="Close settings" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border-radius: 50%;">‚úï</button>
                </div>

                <div class="alert"
                    style="background: rgba(14, 165, 233, 0.1); border: 1px solid var(--accent-color); color: var(--accent-color); padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; margin-bottom: 1rem;">
                    <strong>Requirement:</strong> You must run the local proxy script for this to work.<br>
                    <code>node proxy.js</code>
                </div>
                
                <div class="alert" id="supabase-alert"
                    style="background: rgba(34, 197, 94, 0.1); border: 1px solid var(--success-color); color: var(--success-color); padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; margin-bottom: 1rem; display: none;">
                    <strong>‚úÖ Cloud Storage Active</strong><br>
                    Data is syncing to Supabase. Access from any device!
                </div>
                
                <div class="alert" id="supabase-warning"
                    style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning-color); color: var(--warning-color); padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; margin-bottom: 1rem; display: none;">
                    <strong>‚ö†Ô∏è Local Storage Only</strong><br>
                    Configure Supabase for cloud sync. <a href="#" onclick="window.open('SUPABASE_SETUP.md'); return false;" style="color: var(--warning-color); text-decoration: underline;">Setup Guide</a>
                </div>

                <div class="form-group">
                    <label>Jira Domain (e.g. your-company.atlassian.net)</label>
                    <input type="text" id="jira-domain" placeholder="mycompany.atlassian.net">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="jira-email" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label>API Token</label>
                    <input type="password" id="jira-token" placeholder="ATATT3xFfGF0...">
                </div>
                <div class="form-group">
                    <label>JQL Query (Optional)</label>
                    <input type="text" id="jira-jql" value='project in ("IT Portfolio") and "Technology Squad[Dropdown]" in ("Platform Development & Integration")' placeholder="JQL...">
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                    <button class="btn btn-danger" onclick="clearData()" style="font-size:0.8rem;">üóëÔ∏è Clear Local
                        Data</button>
						<button class="btn btn-primary" onclick="exportDataForEmail()" style="font-size:0.8rem;">
  üì§ Export for Email
</button>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn" onclick="closeSettings()">Cancel</button>
                        <button class="btn btn-primary" onclick="syncJira()">Sync Now</button>
                    </div>
                </div>
                <div id="sync-status" style="margin-top: 0.5rem; text-align: right; font-size: 0.85rem;"></div>
            </div>
        </div>



        
		<script>

// ====================================
// SUPABASE CONFIGURATION
// ====================================
// üîß STEP 1: Replace these with your Supabase project credentials
// Get them from: Supabase Dashboard ‚Üí Settings ‚Üí API
const SUPABASE_URL = 'https://kkqysoquhqoiwqoyphwp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrcXlzb3F1aHFvaXdxb3lwaHdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NjgzMjIsImV4cCI6MjA4NTU0NDMyMn0.YJl8sVng8S6TruNf-46DJiOV7U06MuLicPCaQw7LvPc';

// Initialize Supabase client
let supabaseClient = null;
let useSupabase = false;
let connectionStatus = 'initializing';

// Production Status Update Function
function updateProductionStatus(status, message = '') {
    const banner = document.getElementById('production-status');
    const statusIcon = document.getElementById('status-icon');
    const statusText = document.getElementById('status-text');
    const storageText = document.getElementById('storage-text');
    const statusPulse = document.getElementById('status-pulse');
    
    connectionStatus = status;
    
    switch(status) {
        case 'connected':
            banner.className = 'production-banner';
            banner.style.background = 'linear-gradient(90deg, #22c55e 0%, #16a34a 100%)';
            statusIcon.textContent = '‚òÅÔ∏è';
            statusText.textContent = 'Production Mode | Cloud Storage Active';
            storageText.textContent = 'Cloud Storage ‚úì';
            statusPulse.className = 'status-pulse';
            console.log('‚úÖ Production: Connected to Supabase');
            break;
            
        case 'local':
            banner.className = 'production-banner local';
            banner.style.background = 'linear-gradient(90deg, #eab308 0%, #ca8a04 100%)';
            statusIcon.textContent = 'üíæ';
            statusText.textContent = 'Local Mode | Configure Supabase for Cloud Storage';
            storageText.textContent = 'Local Storage Only';
            statusPulse.className = 'status-pulse warning';
            console.log('‚ÑπÔ∏è Production: Using Local Storage - Configure Supabase for cloud sync');
            break;
            
        case 'error':
            banner.className = 'production-banner error';
            banner.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
            statusIcon.textContent = '‚ö†Ô∏è';
            statusText.textContent = 'Connection Error | Using Local Storage';
            storageText.textContent = 'Error - Local Fallback';
            storageText.title = message || 'Connection failed';
            statusPulse.className = 'status-pulse error';
            console.error('‚ùå Production: Connection error -', message);
            break;
            
        case 'initializing':
        default:
            statusIcon.textContent = '‚è≥';
            statusText.textContent = 'Initializing...';
            storageText.textContent = 'Starting up...';
            statusPulse.className = 'status-pulse';
            break;
    }
}

// Initialize Production Mode
async function initializeProduction() {
    console.log('üöÄ Initializing Production Mode...');
    updateProductionStatus('initializing');
    
    // Check if Supabase is configured
    if (SUPABASE_URL === '' || 
        SUPABASE_ANON_KEY === '') {
        
        console.warn('‚ö†Ô∏è Supabase credentials not configured');
        updateProductionStatus('local');
        useSupabase = false;
        
        // Initialize IndexedDB fallback
        await initDB();
        return;
    }
    
    // Try to initialize Supabase
    try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Test the connection
        const { error } = await supabaseClient
            .from('initiatives')
            .select('count', { count: 'exact', head: true });
        
        if (error) throw error;
        
        useSupabase = true;
        updateProductionStatus('connected');
        
    } catch (error) {
        console.error('Supabase connection failed:', error);
        updateProductionStatus('error', error.message);
        
        // Fall back to IndexedDB
        useSupabase = false;
        await initDB();
    }
}

// Health Check - runs periodically
async function performHealthCheck() {
    if (!useSupabase) return;
    
    try {
        const { error } = await supabaseClient
            .from('initiatives')
            .select('count', { count: 'exact', head: true });
        
        if (error) throw error;
        
        if (connectionStatus !== 'connected') {
            updateProductionStatus('connected');
        }
        
    } catch (error) {
        console.error('Health check failed:', error);
        updateProductionStatus('error', error.message);
    }
}

// Run health check every 5 minutes
setInterval(performHealthCheck, 5 * 60 * 1000);

// ====================================
// SUPABASE DATABASE FUNCTIONS
// ====================================

async function checkSupabaseConnection() {
    return performHealthCheck();
}

// Supabase: Get all initiatives
async function getAllInitiativesFromSupabase() {
    const { data, error } = await supabaseClient
        .from('initiatives')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    // Transform database format to app format and fetch notes for each initiative
    // TODO: Optimize to avoid N+1 queries by batching note fetches
    const initiatives = await Promise.all(data.map(async (item) => {
        const notes = await getNotesFromSupabase(item.id);
        return {
            id: item.id,
            name: item.name,
            owner: item.owner,
            status: item.status,
            startDate: item.start_date,
            targetDate: item.target_date,
            categories: item.categories || [],
            tags: item.tags || [],
            phases: item.phases || [],
            notes: notes || [],
            keyInitiative: item.key_initiative || 'No',
            created_at: item.created_at,
            updated_at: item.updated_at
        };
    }));
    
    return initiatives;
}

/**
 * Get a single initiative by ID from Supabase
 * @param {string} id - The initiative ID to fetch
 * @returns {Promise<Object|null>} Initiative object in app format, or null if not found
 * @throws {Error} If Supabase query fails (except for not found errors)
 * 
 * Error handling:
 * - PGRST116 (not found): Returns null - expected for new initiatives from JIRA
 * - Other errors: Throws error - indicates actual database/connection issues
 */
async function getInitiativeFromSupabase(id) {
    const { data, error } = await supabaseClient
        .from('initiatives')
        .select('*')
        .eq('id', id)
        .single();
    
    if (error) {
        // Return null if not found (not an error for new initiatives)
        if (error.code === 'PGRST116') return null;
        throw error;
    }
    
    // Fetch notes from separate notes table
    const notes = await getNotesFromSupabase(data.id);
    
    // Transform database format to app format
    return {
        id: data.id,
        name: data.name,
        owner: data.owner,
        status: data.status,
        startDate: data.start_date,
        targetDate: data.target_date,
        categories: data.categories || [],
        tags: data.tags || [],
        phases: data.phases || [],
        notes: notes || [],
        keyInitiative: data.key_initiative || 'No',
        created_at: data.created_at,
        updated_at: data.updated_at
    };
}

// Supabase: Save initiative
async function saveInitiativeToSupabase(initiative) {
    const dbFormat = {
        id: initiative.id,
        name: initiative.name,
        owner: initiative.owner,
        status: initiative.status,
        start_date: initiative.startDate,
        target_date: initiative.targetDate,
        categories: initiative.categories || [],
        tags: initiative.tags || [],
        phases: initiative.phases || [],
        key_initiative: initiative.keyInitiative || 'No',
        updated_at: new Date().toISOString()
    };
    
    const { data, error } = await supabaseClient
        .from('initiatives')
        .upsert(dbFormat)
        .select()
        .single();
    
    if (error) throw error;
    
    // Save notes to separate notes table
    if (initiative.notes && initiative.notes.length > 0) {
        await saveNotesToSupabase(initiative.id, initiative.notes);
    }
    
    console.log('üíæ Saved to Supabase:', initiative.id, initiative.name);
    return initiative;
}

// Supabase: Delete initiative
async function deleteInitiativeFromSupabase(id) {
    const { error } = await supabaseClient
        .from('initiatives')
        .delete()
        .eq('id', id);
    
    if (error) throw error;
    
    // Also delete associated notes
    await deleteNotesForInitiative(id);
}

// Supabase: Save notes for an initiative
async function saveNotesToSupabase(initiativeId, notes) {
    if (!notes || notes.length === 0) return;
    
    // Delete existing notes for this initiative first
    await deleteNotesForInitiative(initiativeId);
    
    // Insert all notes
    const notesData = notes.map(note => ({
        id: note.id,
        initiative_id: initiativeId,
        text: note.text,
        author: note.author,
        created_at: note.date
    }));
    
    const { error } = await supabaseClient
        .from('notes')
        .insert(notesData);
    
    if (error) throw error;
}

// Supabase: Get notes for an initiative
async function getNotesFromSupabase(initiativeId) {
    const { data, error } = await supabaseClient
        .from('notes')
        .select('*')
        .eq('initiative_id', initiativeId)
        .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    // Transform to app format
    return data.map(note => ({
        id: note.id,
        text: note.text,
        author: note.author,
        date: note.created_at
    }));
}

// Supabase: Delete notes for an initiative
async function deleteNotesForInitiative(initiativeId) {
    const { error } = await supabaseClient
        .from('notes')
        .delete()
        .eq('initiative_id', initiativeId);
    
    // Ignore error if table doesn't exist or no notes found
    // PGRST116 = PostgREST error code for "no rows found"
    if (error && error.code !== 'PGRST116') {
        console.warn('Failed to delete notes:', error);
    }
}

// Supabase: Get all snapshots
async function getAllSnapshotsFromSupabase() {
    const { data, error } = await supabaseClient
        .from('snapshots')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    return data.map(item => ({
        id: item.id.toString(),
        note: item.note,
        data: JSON.stringify(item.data),
        created_at: item.created_at
    }));
}

// Supabase: Create snapshot
async function createSnapshotInSupabase(note, initiatives = null) {
    // If initiatives not provided, fetch all initiatives (for backwards compatibility)
    if (!initiatives) {
        initiatives = await getAllInitiatives();
    }
    
    const { data, error } = await supabaseClient
        .from('snapshots')
        .insert({
            note: note || '',
            data: initiatives
        })
        .select()
        .single();
    
    if (error) throw error;
    
    return {
        id: data.id.toString(),
        note: data.note,
        data: JSON.stringify(data.data),
        created_at: data.created_at
    };
}


// Supabase: Get all activities
async function getAllActivitiesFromSupabase() {
    const { data, error } = await supabaseClient
        .from('activities')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(10);
    
    if (error) throw error;
    
    return data.map(item => ({
        id: item.id,
        type: item.type,
        icon: item.icon,
        text: item.text,
        meta: item.meta,
        timestamp: item.timestamp,
        initiativeId: item.initiative_id,
        initiativeName: item.initiative_name
    }));
}

// Supabase: Save activity
async function saveActivityToSupabase(activity) {
    const dbFormat = {
        type: activity.type,
        icon: activity.icon,
        text: activity.text,
        meta: activity.meta,
        timestamp: activity.timestamp,
        initiative_id: activity.initiativeId,
        initiative_name: activity.initiativeName
    };
    
    const { data, error } = await supabaseClient
        .from('activities')
        .insert(dbFormat)
        .select()
        .single();
    
    if (error) throw error;
    
    console.log('üíæ Activity saved to Supabase:', activity.type);
    return {
        id: data.id,
        type: data.type,
        icon: data.icon,
        text: data.text,
        meta: data.meta,
        timestamp: data.timestamp,
        initiativeId: data.initiative_id,
        initiativeName: data.initiative_name
    };
}


// Update storage status indicator in UI
function updateStorageStatus() {
    const statusDiv = document.getElementById('storage-status');
    const supabaseAlert = document.getElementById('supabase-alert');
    const supabaseWarning = document.getElementById('supabase-warning');
    const migrateBtn = document.getElementById('btn-migrate');
    
    if (!statusDiv) return;
    
    if (useSupabase) {
        statusDiv.innerHTML = '‚òÅÔ∏è Cloud Storage';
        statusDiv.style.color = 'var(--success-color)';
        if (supabaseAlert) supabaseAlert.style.display = 'block';
        if (supabaseWarning) supabaseWarning.style.display = 'none';
        if (migrateBtn) migrateBtn.style.display = 'none';
    } else {
        statusDiv.innerHTML = 'üíæ Local Storage';
        statusDiv.style.color = 'var(--text-muted)';
        if (supabaseAlert) supabaseAlert.style.display = 'none';
        if (supabaseWarning) supabaseWarning.style.display = 'block';
        // Show migrate button if there's local data
        if (migrateBtn && db) {
            getAllInitiatives().then(initiatives => {
                if (initiatives.length > 0) {
                    migrateBtn.style.display = 'inline-block';
                }
            });
        }
    }
}

// Migration function to move data from IndexedDB to Supabase
async function migrateToSupabase() {
    if (!useSupabase) {
        alert('Please configure Supabase credentials first!');
        return;
    }
    
    if (!confirm('This will copy all your local data to Supabase. Continue?')) {
        return;
    }
    
    try {
        console.log('Starting migration to Supabase...');
        
        // Ensure IndexedDB is initialized
        if (!db) await initDB();
        
        // Get all local data
        const localInitiatives = await getAllInitiatives();
        const localSnapshots = await getAllSnapshotsFromDB();
        
        console.log(`Migrating ${localInitiatives.length} initiatives...`);
        
        // Migrate initiatives
        for (const initiative of localInitiatives) {
            await saveInitiativeToSupabase(initiative);
        }
        
        console.log(`Migrating ${localSnapshots.length} snapshots...`);
        
        // Migrate snapshots
        for (const snapshot of localSnapshots) {
            await supabaseClient.from('snapshots').insert({
                note: snapshot.note,
                data: JSON.parse(snapshot.data)
            });
        }
        
        console.log('‚úÖ Migration complete!');
        alert(`Successfully migrated ${localInitiatives.length} initiatives and ${localSnapshots.length} snapshots to Supabase!`);
        
        // Reload from Supabase
        await loadState();
        
    } catch (error) {
        console.error('Migration failed:', error);
        alert('Migration failed: ' + error.message);
    }
}

		
		// Populate default phases for initiatives without phases
async function populateDefaultPhases() {
    const defaultPhases = [
        {
            name: 'Solutioning',
            color: '#8b5cf6', // Violet
            startDate: '2025-12-01T00:00:00.000Z',
            endDate: '2026-01-31T23:59:59.000Z',
            status: 'pending'
        },
        {
            name: 'Development',
            color: '#a855f7', // Purple
            startDate: '2026-01-01T00:00:00.000Z',
            endDate: '2026-03-31T23:59:59.000Z',
            status: 'pending'
        },
        {
            name: 'QA',
            color: '#ec4899', // Pink
            startDate: '2026-03-01T00:00:00.000Z',
            endDate: '2026-04-30T23:59:59.000Z',
            status: 'pending'
        },
        {
            name: 'UAT Sign-off',
            color: '#f59e0b', // Amber
            startDate: '2026-04-01T00:00:00.000Z',
            endDate: '2026-04-30T23:59:59.000Z',
            status: 'pending'
        },
        {
            name: 'Go-live',
            color: '#22c55e', // Green
            startDate: '2026-05-01T00:00:00.000Z',
            endDate: '2026-05-31T23:59:59.000Z',
            status: 'pending'
        }
    ];

    let updatedCount = 0;
    let skippedCount = 0;

    for (const initiative of appState.initiatives) {
        // Check if initiative already has phases
        if (!initiative.phases || initiative.phases.length === 0) {
            // Add default phases with unique IDs
            initiative.phases = defaultPhases.map((phase, index) => ({
                id: `${initiative.id}-phase-${Date.now()}-${index}`,
                name: phase.name,
                color: phase.color,
                startDate: phase.startDate,
                endDate: phase.endDate,
                status: phase.status
            }));

            // Save to database
            try {
                await saveInitiativeToDB(initiative);
                updatedCount++;
                console.log(`‚úÖ Added phases to: ${initiative.name} (${initiative.id})`);
            } catch (error) {
                console.error(`‚ùå Failed to update ${initiative.id}:`, error);
            }
        } else {
            skippedCount++;
            console.log(`‚è≠Ô∏è  Skipped (already has phases): ${initiative.name} (${initiative.id})`);
        }
    }

    // Reload data and render
    await loadState();

    // Show summary
    alert(`
‚úÖ Phases Population Complete!

Updated: ${updatedCount} initiatives
Skipped: ${skippedCount} initiatives (already had phases)

Default phases added:
‚Ä¢ Solutioning (Dec 2025 - Jan 2026)
‚Ä¢ Development (Jan 2026 - Mar 2026)
‚Ä¢ QA (Mar 2026 - Apr 2026)
‚Ä¢ UAT Sign-off (Apr 2026)
‚Ä¢ Go-live (May 2026)
    `);
}
		
		/**
		 * Export Data for Email Scheduler
		 * 
		 * This function exports initiative data to an external email scheduler service.
		 * The service should be running on http://localhost:3001/api/export-data
		 * 
		 * For weekly automated emails:
		 * 1. Set up a cron job or scheduler to call this function weekly
		 * 2. Or use the email scheduler service with its own scheduling mechanism
		 * 3. The service should format and send status summary emails
		 * 
		 * Email Content should include:
		 * - Summary of initiatives by status (Active, Risk, Planned, Completed)
		 * - List of key initiatives
		 * - Initiatives approaching target dates
		 * - Overdue initiatives
		 */
		async function exportDataForEmail() {
  try {
    const initiatives = await getAllInitiatives();
    
    // Prepare summary statistics for email
    const summary = {
      total: initiatives.length,
      byStatus: {
        active: initiatives.filter(i => i.status === 'active').length,
        risk: initiatives.filter(i => i.status === 'risk').length,
        planned: initiatives.filter(i => i.status === 'planned').length,
        completed: initiatives.filter(i => i.status === 'completed').length
      },
      keyInitiatives: initiatives.filter(i => i.keyInitiative === 'Yes' || (i.keyInitiative && i.keyInitiative !== 'No')).length,
      approachingDeadline: initiatives.filter(i => {
        const daysUntilTarget = Math.ceil((new Date(i.targetDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
        return daysUntilTarget > 0 && daysUntilTarget <= 14;
      }).length,
      overdue: initiatives.filter(i => new Date(i.targetDate).getTime() < new Date().getTime() && i.status !== 'completed').length
    };
    
    const response = await fetch('http://localhost:3001/api/export-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        initiatives, 
        summary,
        exportDate: new Date().toISOString() 
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    alert(result.success ? '‚úÖ Data exported for email!' : '‚ùå Export failed: ' + (result.error || 'Unknown error'));
  } catch (error) {
    console.error('Email export error:', error);
    alert('‚ùå Email scheduler service not available!\n\nPlease ensure the email service is running on http://localhost:3001\n\nFor setup instructions, see the documentation.');
  }
}
// ========== IndexedDB Database Layer ==========
const DB_NAME = 'InitiativeTrackerDB';
const DB_VERSION = 2; // Incremented to add activities table
let db = null;

function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      console.log('‚úÖ IndexedDB initialized');
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      
      if (!db.objectStoreNames.contains('initiatives')) {
        const initiativeStore = db.createObjectStore('initiatives', { keyPath: 'id' });
        initiativeStore.createIndex('status', 'status', { unique: false });
        initiativeStore.createIndex('owner', 'owner', { unique: false });
      }
      
      if (!db.objectStoreNames.contains('snapshots')) {
        db.createObjectStore('snapshots', { keyPath: 'id', autoIncrement: true });
      }
      
      if (!db.objectStoreNames.contains('activities')) {
        const activityStore = db.createObjectStore('activities', { keyPath: 'id', autoIncrement: true });
        activityStore.createIndex('timestamp', 'timestamp', { unique: false });
        activityStore.createIndex('type', 'type', { unique: false });
      }
      
      console.log('‚úÖ Database schema created');
    };
  });
}

async function getAllInitiatives() {
  if (useSupabase) {
    return await getAllInitiativesFromSupabase();
  }
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['initiatives'], 'readonly');
    const store = transaction.objectStore('initiatives');
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

/**
 * Get a single initiative by ID from the database (abstraction layer)
 * Routes to Supabase or IndexedDB based on useSupabase flag
 * @param {string} id - The initiative ID to fetch
 * @returns {Promise<Object|null>} Initiative object, or null if not found in either storage backend
 * 
 * This provides a consistent interface regardless of storage backend:
 * - Supabase: Returns transformed data or null
 * - IndexedDB: Returns stored data or null
 */
async function getInitiativeFromDB(id) {
  if (useSupabase) {
    return await getInitiativeFromSupabase(id);
  }
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['initiatives'], 'readonly');
    const store = transaction.objectStore('initiatives');
    const request = store.get(id);
    request.onsuccess = () => resolve(request.result || null);
    request.onerror = () => reject(request.error);
  });
}

async function saveInitiativeToDB(initiative) {
  if (useSupabase) {
    return await saveInitiativeToSupabase(initiative);
  }
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['initiatives'], 'readwrite');
    const store = transaction.objectStore('initiatives');
    
    if (!initiative.created_at) {
      initiative.created_at = new Date().toISOString();
    }
    initiative.updated_at = new Date().toISOString();
    
    const request = store.put(initiative);
    request.onsuccess = () => {
      console.log('üíæ Saved initiative to DB:', initiative.id, initiative.name);
      resolve(initiative);
    };
    request.onerror = () => {
      console.error('‚ùå Failed to save initiative:', initiative.id, request.error);
      reject(request.error);
    };
  });
}

async function getAllSnapshotsFromDB() {
  if (useSupabase) {
    return await getAllSnapshotsFromSupabase();
  }
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['snapshots'], 'readonly');
    const store = transaction.objectStore('snapshots');
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function createSnapshotInDB(note, initiatives = null) {
  if (useSupabase) {
    return await createSnapshotInSupabase(note, initiatives);
  }
  
  return new Promise(async (resolve, reject) => {
    try {
      // If initiatives not provided, fetch all initiatives (for backwards compatibility)
      if (!initiatives) {
        initiatives = await getAllInitiatives();
      }
      
      const snapshot = {
        note: note || '',
        data: JSON.stringify(initiatives),
        created_at: new Date().toISOString()
      };
      
      const transaction = db.transaction(['snapshots'], 'readwrite');
      const store = transaction.objectStore('snapshots');
      const request = store.add(snapshot);
      
      request.onsuccess = () => {
        snapshot.id = request.result;
        resolve(snapshot);
      };
      request.onerror = () => reject(request.error);
    } catch (error) {
      reject(error);
    }
  });
}

// ====================================
// ACTIVITIES DATABASE FUNCTIONS
// ====================================

async function getAllActivitiesFromDB() {
  if (useSupabase) {
    return await getAllActivitiesFromSupabase();
  }
  
  return new Promise((resolve, reject) => {
    if (!db) {
      resolve([]);
      return;
    }
    
    const transaction = db.transaction(['activities'], 'readonly');
    const store = transaction.objectStore('activities');
    const index = store.index('timestamp');
    const request = index.openCursor(null, 'prev'); // descending order
    
    const activities = [];
    let count = 0;
    
    request.onsuccess = (event) => {
      const cursor = event.target.result;
      if (cursor && count < 10) {
        activities.push(cursor.value);
        count++;
        cursor.continue();
      } else {
        resolve(activities);
      }
    };
    request.onerror = () => reject(request.error);
  });
}

async function saveActivityToDB(activity) {
  if (useSupabase) {
    return await saveActivityToSupabase(activity);
  }
  
  return new Promise((resolve, reject) => {
    if (!db) {
      console.warn('‚ö†Ô∏è Database not initialized, skipping activity save');
      resolve(activity);
      return;
    }
    
    const transaction = db.transaction(['activities'], 'readwrite');
    const store = transaction.objectStore('activities');
    
    if (!activity.timestamp) {
      activity.timestamp = new Date().toISOString();
    }
    
    const request = store.add(activity);
    request.onsuccess = () => {
      activity.id = request.result;
      console.log('üíæ Activity saved to DB:', activity.type);
      resolve(activity);
    };
    request.onerror = () => {
      console.error('‚ùå Failed to save activity:', request.error);
      reject(request.error);
    };
  });
}

// ... rest of your code
		
		// Modern Color Palette
const MODERN_COLORS = [
    '#3b82f6', '#8b5cf6', '#a855f7', '#ec4899', '#f43f5e',
    '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#f59e0b',
    '#f97316', '#ef4444', '#6366f1', '#84cc16', '#eab308'
];

function getRandomModernColor() {
    return MODERN_COLORS[Math.floor(Math.random() * MODERN_COLORS.length)];
}
		
            // --- STATE ---
            let appState = {
                initiatives: [],
                snapshots: [],
                filterStatus: 'all',
                filterCategory: 'all',
                sortKey: 'name',
                sortOrder: 'asc', // asc or desc
                timelineFilters: {
                    name: '',
                    key: false,
                    owner: '',
                    status: [],
                    targetDate: ''
                },
                // Pagination state for initiatives list
                initiativesPage: 1,
                initiativesPerPage: 10,
                // Current active view: 'current' (dashboard), 'timeline', or 'snapshots'
                activeView: 'current'
            };
            let editingId = null;
            let editingCopy = null;

            // Drag State
            let dragData = {
                active: false,
                phaseId: null,
                initiativeId: null,
                startX: 0,
                originalStart: 0,
                originalEnd: 0,
                element: null,
                msPerPixel: 0
            };

            // --- TIMELINE CONSTANTS ---
            const PHASE_COLORS = {
                'Planning': '#3b82f6', // Blue
                'Design': '#8b5cf6', // Violet
                'Development': '#a855f7', // Purple
                'QA': '#ec4899', // Pink
                'Launch': '#22c55e', // Green
                'Migration': '#f59e0b', // Amber
            };
            const DEFAULT_PHASE_COLOR = '#64748b'; // Slate
            const BAR_HEIGHT = 20;
            const BAR_GAP = 4;
            const LANE_HEIGHT = BAR_HEIGHT + BAR_GAP;

            // --- STORAGE ---
const loadState = async () => {
  try {
    // Initialize database if using IndexedDB
    if (!useSupabase && !db) {
      await initDB();
    }
    
    appState.initiatives = await getAllInitiatives();
    const source = useSupabase ? 'Supabase' : 'IndexedDB';
    console.log(`‚úÖ Loaded ${appState.initiatives.length} initiatives from ${source}`);
    
    const snapshots = await getAllSnapshotsFromDB();
    appState.snapshots = snapshots.map(s => ({
      id: s.id.toString(),
      date: s.created_at,
      initiatives: JSON.parse(s.data),
      note: s.note
    }));
    
    render();
  } catch (error) {
    console.error('‚ùå Error loading data:', error);
    alert('Failed to load data: ' + error.message);
  }
};

            const saveState = () => {
                localStorage.setItem('retro_astro_initiatives_vanilla', JSON.stringify(appState.initiatives));
                localStorage.setItem('retro_astro_snapshots_vanilla', JSON.stringify(appState.snapshots));
                render();
            };

            // --- ACTIONS ---
            function seedData() {
                appState.initiatives = [
                    {
                        id: '1', name: 'Q1 Core Platform Migration', owner: 'Alice DB', status: 'active',
                        startDate: new Date(Date.now() - 864e5 * 10).toISOString(),
                        targetDate: new Date(Date.now() + 864e5 * 45).toISOString(),
                        categories: ['Platform Development'],
                        phases: [
                            { id: 'p1', name: 'Planning', color: '#3b82f6', startDate: new Date(Date.now() - 864e5 * 10).toISOString(), endDate: new Date(Date.now() - 864e5 * 5).toISOString(), status: 'completed' },
                            { id: 'p2', name: 'Migration', color: '#f59e0b', startDate: new Date(Date.now() - 864e5 * 4).toISOString(), endDate: new Date(Date.now() + 864e5 * 30).toISOString(), status: 'active' },
                            { id: 'p3', name: 'QA', color: '#ec4899', startDate: new Date(Date.now() + 864e5 * 31).toISOString(), endDate: new Date(Date.now() + 864e5 * 45).toISOString(), status: 'pending' }
                        ]
                    },
                    { id: '2', name: 'Mobile App Refactor', owner: 'Bob Mobile', status: 'risk', categories: ['Platform Development', 'Mobile'], startDate: new Date(Date.now() - 864e5 * 20).toISOString(), targetDate: new Date(Date.now() + 864e5 * 5).toISOString(), phases: [] },
                    { id: '3', name: 'Design System 2.0', owner: 'Carol UI', status: 'planned', categories: ['Enterprise Integration'], startDate: new Date(Date.now() + 864e5 * 5).toISOString(), targetDate: new Date(Date.now() + 864e5 * 60).toISOString(), phases: [] },
                    { id: '4', name: 'Legacy API Shutdown', owner: 'Dave Ops', status: 'completed', categories: ['Enterprise Integration'], startDate: new Date(Date.now() - 864e5 * 40).toISOString(), targetDate: new Date(Date.now() - 864e5 * 10).toISOString(), phases: [] },
                    { id: '5', name: 'Customer Portal V3', owner: 'Sarah N.', status: 'active', categories: ['Enterprise Integration'], startDate: new Date(Date.now() - 864e5 * 15).toISOString(), targetDate: new Date(Date.now() + 864e5 * 30).toISOString(), phases: [] },
                    { id: '6', name: 'Analytics Dashboard', owner: 'Mike Data', status: 'risk', categories: ['Platform Development'], startDate: new Date(Date.now() - 864e5 * 25).toISOString(), targetDate: new Date(Date.now() - 864e5 * 2).toISOString(), phases: [] },
                    { id: '7', name: 'Onboarding Flow Optimization', owner: 'Jessica P.', status: 'completed', startDate: new Date(Date.now() - 864e5 * 50).toISOString(), targetDate: new Date(Date.now() - 864e5 * 15).toISOString(), phases: [] },
                    { id: '8', name: 'AI Recommendation Engine', owner: 'Tom AI', status: 'planned', categories: ['Platform Development'], startDate: new Date(Date.now() + 864e5 * 10).toISOString(), targetDate: new Date(Date.now() + 864e5 * 90).toISOString(), phases: [] }
                ];
                saveState();
            }

            // --- MODAL & PHASES ---
            function openModal(id) {
                editingId = id;
                const note = appState.initiatives.find(i => i.id === id);
                if (!note) return;
                editingCopy = JSON.parse(JSON.stringify(note));

                document.getElementById('edit-name').value = editingCopy.name;
                document.getElementById('edit-owner').value = editingCopy.owner;
                document.getElementById('edit-start').value = editingCopy.startDate.split('T')[0];
                document.getElementById('edit-target').value = editingCopy.targetDate.split('T')[0];
                document.getElementById('edit-status').value = editingCopy.status;

                // Initialize multi-select components
                initializeMultiSelect('categories', editingCopy.categories || []);
                initializeMultiSelect('tags', editingCopy.tags || []);

                renderPhases();
                renderNotes(); // Render notes section

                document.getElementById('modal-wrapper').classList.remove('hidden');
                
                // Setup date validation listeners
                setupDateValidationListeners();
            }

            function closeModal() {
                document.getElementById('modal-wrapper').classList.add('hidden');
                editingId = null;
                editingCopy = null;
            }

            async function saveContext() {
  if (!editingId || !editingCopy) return;
  
  editingCopy.name = document.getElementById('edit-name').value;
  editingCopy.owner = document.getElementById('edit-owner').value;
  
  const startDate = new Date(document.getElementById('edit-start').value);
  const targetDate = new Date(document.getElementById('edit-target').value);
  
  // Validate main initiative dates
  if (startDate > targetDate) {
    alert('‚ö†Ô∏è Start Date cannot be later than Target Date!\n\nStart: ' + startDate.toLocaleDateString() + '\nTarget: ' + targetDate.toLocaleDateString());
    
    // Add visual feedback
    const startInput = document.getElementById('edit-start');
    const targetInput = document.getElementById('edit-target');
    startInput.classList.add('error');
    targetInput.classList.add('error');
    setTimeout(() => {
      startInput.classList.remove('error');
      targetInput.classList.remove('error');
    }, 500);
    
    return;
  }
  
  editingCopy.startDate = startDate.toISOString();
  editingCopy.targetDate = targetDate.toISOString();
  editingCopy.status = document.getElementById('edit-status').value;
  editingCopy.categories = getMultiSelectValues('categories');
  editingCopy.tags = getMultiSelectValues('tags');
  editingCopy.updatedDate = new Date(); // Track last update for activity feed
  
  // Validate all phases
  if (editingCopy.phases && editingCopy.phases.length > 0) {
    for (let i = 0; i < editingCopy.phases.length; i++) {
      const phase = editingCopy.phases[i];
      const phaseStart = new Date(phase.startDate);
      const phaseEnd = new Date(phase.endDate);
      
      if (phaseStart > phaseEnd) {
        alert('‚ö†Ô∏è Phase "' + phase.name + '" has invalid dates!\n\nStart Date cannot be later than End Date.\n\nPhase Start: ' + phaseStart.toLocaleDateString() + '\nPhase End: ' + phaseEnd.toLocaleDateString());
        return;
      }
    }
  }
  
  try {
    // Get the old initiative to check what changed
    const oldInitiative = appState.initiatives.find(i => i.id === editingId);
    
    const saved = await saveInitiativeToDB(editingCopy);
    
    const idx = appState.initiatives.findIndex(i => i.id === editingId);
    if (idx !== -1) {
      appState.initiatives[idx] = saved;
    } else {
      appState.initiatives.push(saved);
    }
    
    // Log activity based on what changed
    try {
      if (oldInitiative && oldInitiative.status !== 'completed' && editingCopy.status === 'completed') {
        // Initiative was just marked as completed
        await saveActivityToDB({
          type: 'completed',
          icon: '‚úì',
          text: `${editingCopy.name} marked as completed`,
          meta: editingCopy.owner, // Store only owner, compute relative time at display
          timestamp: new Date().toISOString(),
          initiativeId: editingCopy.id,
          initiativeName: editingCopy.name
        });
      } else if (oldInitiative) {
        // Initiative was updated
        await saveActivityToDB({
          type: 'updated',
          icon: 'üìù',
          text: `Updated ${editingCopy.name}`,
          meta: editingCopy.owner, // Store only owner, compute relative time at display
          timestamp: new Date().toISOString(),
          initiativeId: editingCopy.id,
          initiativeName: editingCopy.name
        });
      }
    } catch (activityError) {
      console.error('Failed to log activity:', activityError);
      // Don't fail the save if activity logging fails
    }
    
    render();
    closeModal();
  } catch (error) {
    alert('Failed to save: ' + error.message);
  }
}

            // --- DATE VALIDATION ON BLUR ---
            function validateMainDatesOnBlur() {
                const startInput = document.getElementById('edit-start');
                const targetInput = document.getElementById('edit-target');
                
                if (!startInput.value || !targetInput.value) {
                    return; // Skip validation if dates are not set
                }
                
                const startDate = new Date(startInput.value);
                const targetDate = new Date(targetInput.value);
                
                if (startDate > targetDate) {
                    // Add error styling
                    startInput.classList.add('error');
                    targetInput.classList.add('error');
                    startInput.title = 'Start Date must be before Target Date';
                    targetInput.title = 'Target Date must be after Start Date';
                } else {
                    // Remove error styling
                    startInput.classList.remove('error');
                    targetInput.classList.remove('error');
                    startInput.title = '';
                    targetInput.title = '';
                }
            }
            
            function setupDateValidationListeners() {
                const startInput = document.getElementById('edit-start');
                const targetInput = document.getElementById('edit-target');
                
                if (startInput && targetInput) {
                    startInput.addEventListener('blur', validateMainDatesOnBlur);
                    targetInput.addEventListener('blur', validateMainDatesOnBlur);
                }
            }

            // --- MULTI-SELECT HELPERS ---
            let selectedCategories = [];
            let selectedTags = [];

            function initializeMultiSelect(type, values) {
                if (type === 'categories') {
                    selectedCategories = [...values];
                    renderSelectedItems('categories');
                    renderDropdownOptions('categories');
                } else if (type === 'tags') {
                    selectedTags = [...values];
                    renderSelectedItems('tags');
                    renderDropdownOptions('tags');
                }
            }

            function getMultiSelectValues(type) {
                return type === 'categories' ? selectedCategories : selectedTags;
            }

            function getAllOptions(type) {
                const allItems = new Set();
                appState.initiatives.forEach(i => {
                    const items = type === 'categories' ? (i.categories || []) : (i.tags || []);
                    items.forEach(item => allItems.add(item));
                });
                return Array.from(allItems).sort();
            }

            function renderSelectedItems(type) {
                const container = document.querySelector(`#${type}-multiselect .selected-items`);
                const input = document.getElementById(`${type}-input`);
                const selected = type === 'categories' ? selectedCategories : selectedTags;

                Array.from(container.children).forEach(child => {
                    if (child !== input) child.remove();
                });

                selected.forEach(item => {
                    const badge = document.createElement('div');
                    badge.className = 'selected-item';
                    badge.innerHTML = `
                        <span>${item}</span>
                        <span class="remove" onmousedown="removeItem('${type}', '${item}')">√ó</span>
                    `;
                    container.insertBefore(badge, input);
                });
            }

            function renderDropdownOptions(type, filter = '') {
                const dropdown = document.getElementById(`${type}-dropdown`);
                const allOptions = getAllOptions(type);
                const selected = type === 'categories' ? selectedCategories : selectedTags;
                const input = document.getElementById(`${type}-input`);
                const inputValue = input.value.trim();

                let options = allOptions.filter(opt =>
                    opt.toLowerCase().includes(filter.toLowerCase()) && !selected.includes(opt)
                );

                if (inputValue && !allOptions.includes(inputValue) && !selected.includes(inputValue)) {
                    options = [`+ Create "${inputValue}"`, ...options];
                }

                dropdown.innerHTML = options.map(opt => {
                    const isCreate = opt.startsWith('+ Create');
                    return `<div class="multi-select-option" onmousedown="selectOption('${type}', '${isCreate ? inputValue : opt}')">${opt}</div>`;
                }).join('');

                if (options.length === 0) {
                    dropdown.innerHTML = '<div class="multi-select-option" style="color: var(--text-muted);">No options</div>';
                }
            }

            function selectOption(type, value) {
                const selected = type === 'categories' ? selectedCategories : selectedTags;
                if (!selected.includes(value)) {
                    selected.push(value);
                    if (type === 'categories') selectedCategories = selected;
                    else selectedTags = selected;

                    renderSelectedItems(type);
                    renderDropdownOptions(type);
                    document.getElementById(`${type}-input`).value = '';
                    document.getElementById(`${type}-input`).focus();
                }
            }

            function removeItem(type, value) {
                if (type === 'categories') {
                    selectedCategories = selectedCategories.filter(c => c !== value);
                } else {
                    selectedTags = selectedTags.filter(t => t !== value);
                }
                renderSelectedItems(type);
                renderDropdownOptions(type);
            }

            function focusCategoriesInput() {
                document.getElementById('categories-input').focus();
            }

            function focusTagsInput() {
                document.getElementById('tags-input').focus();
            }

            function showCategoriesDropdown() {
                renderDropdownOptions('categories');
                document.getElementById('categories-dropdown').classList.remove('hidden');
            }

            function showTagsDropdown() {
                renderDropdownOptions('tags');
                document.getElementById('tags-dropdown').classList.remove('hidden');
            }

            function hideCategoriesDropdown() {
                setTimeout(() => {
                    document.getElementById('categories-dropdown').classList.add('hidden');
                }, 200);
            }

            function hideTagsDropdown() {
                setTimeout(() => {
                    document.getElementById('tags-dropdown').classList.add('hidden');
                }, 200);
            }

            function filterCategoriesDropdown(value) {
                renderDropdownOptions('categories', value);
            }

            function filterTagsDropdown(value) {
                renderDropdownOptions('tags', value);
            }

            function handleCategoriesKeydown(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const value = event.target.value.trim();
                    if (value) {
                        selectOption('categories', value);
                    }
                } else if (event.key === 'Backspace' && event.target.value === '' && selectedCategories.length > 0) {
                    selectedCategories.pop();
                    renderSelectedItems('categories');
                    renderDropdownOptions('categories');
                }
            }

            function handleTagsKeydown(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const value = event.target.value.trim();
                    if (value) {
                        selectOption('tags', value);
                    }
                } else if (event.key === 'Backspace' && event.target.value === '' && selectedTags.length > 0) {
                    selectedTags.pop();
                    renderSelectedItems('tags');
                    renderDropdownOptions('tags');
                }
            }

            function renderPhases() {
                const tbody = document.getElementById('phases-list');
                tbody.innerHTML = '';

                if (!editingCopy.phases) editingCopy.phases = [];

                if (editingCopy.phases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-muted); font-size:0.8rem;">No phases added yet.</td></tr>';
                    return;
                }

                const now = new Date();
                
                // Count overdue phases
                const overduePhases = editingCopy.phases.filter(p => {
                    const endDate = new Date(p.endDate);
                    return endDate < now && p.status !== 'completed';
                });
                
                // Add overdue warning banner if there are overdue phases
                if (overduePhases.length > 0) {
                    const warningRow = document.createElement('tr');
                    warningRow.innerHTML = `
                        <td colspan="5" style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 2px solid var(--danger-color); border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üö®</span>
                                <div>
                                    <strong style="color: var(--danger-color);">ATTENTION: ${overduePhases.length} Overdue Phase${overduePhases.length !== 1 ? 's' : ''}</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 2px;">
                                        ${overduePhases.map(p => {
                                            const days = Math.ceil((now - new Date(p.endDate)) / (1000 * 60 * 60 * 24));
                                            return `${p.name} (${days} day${days !== 1 ? 's' : ''} overdue)`;
                                        }).join(' ‚Ä¢ ')}
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(warningRow);
                }
                
                editingCopy.phases.forEach((phase, idx) => {
                    const tr = document.createElement('tr');
                    // Resolve color: explicit > mapped > default
                    const color = phase.color || PHASE_COLORS[phase.name] || PHASE_COLORS[phase.name.split(' ')[0]] || DEFAULT_PHASE_COLOR;
                    
                    // Check if phase is overdue (past end date and not completed)
                    const endDate = new Date(phase.endDate);
                    const isOverdue = endDate < now && phase.status !== 'completed';
                    const daysOverdue = isOverdue ? Math.ceil((now - endDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Add overdue class to row for styling
                    if (isOverdue) {
                        tr.classList.add('phase-overdue');
                        tr.dataset.daysOverdue = daysOverdue;
                    }

                    tr.innerHTML = `
                <td style="padding:0.5rem; width: 22%; vertical-align: middle;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        ${isOverdue ? '<span style="color: var(--danger-color); font-weight: bold; font-size: 0.9rem; flex-shrink: 0;" title="OVERDUE by ' + daysOverdue + ' day(s)">üö®</span>' : ''}
                        <input class="phase-input" onchange="updatePhase(${idx}, 'name', this.value)" value="${phase.name}" style="width:100%; min-width: 0;">
                    </div>
                </td>
                <td style="padding:0.5rem; width: 8%; text-align: center; vertical-align: middle;">
                    <input type="color" value="${color}" onchange="updatePhase(${idx}, 'color', this.value)" style="width: 50px; height: 35px; cursor: pointer;">
                </td>
                <td style="padding:0.5rem; width: 40%; vertical-align: middle;">
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                         <div style="flex:1; min-width: 0;">
                             <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:2px;">Start</label>
                             <input type="date" value="${phase.startDate ? phase.startDate.split('T')[0] : ''}" onchange="updatePhase(${idx}, 'startDate', this.valueAsString)" class="date-safe" style="width:100%;" title="Phase Start Date">
                         </div>
                         <span style="color:var(--text-muted); padding-top:18px; flex-shrink: 0;">‚Üí</span>
                         <div style="flex:1; min-width: 0;">
                             <label style="font-size:0.7rem; color:var(--text-muted); display:block; margin-bottom:2px;">End</label>
                             <input type="date" value="${phase.endDate ? phase.endDate.split('T')[0] : ''}" onchange="updatePhase(${idx}, 'endDate', this.valueAsString)" class="date-safe-end" style="width:100%;" title="Phase End Date">
                         </div>
                    </div>
                </td>
                <td style="padding:0.5rem; width: 18%; vertical-align: middle;">
                    <select onchange="updatePhase(${idx}, 'status', this.value)" style="width: 100%;">
                        <option value="pending" ${phase.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="active" ${phase.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="completed" ${phase.status === 'completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </td>
                <td style="padding:0.5rem; width: 12%; text-align: center; vertical-align: middle;">
                    <button class="btn btn-sm btn-danger" onclick="deletePhase(${idx})">üóëÔ∏è</button>
                </td>
            `;
                    const startInput = tr.querySelector('.date-safe');
                    startInput.onchange = (e) => updatePhase(idx, 'startDate', new Date(e.target.value).toISOString());
                    const endInput = tr.querySelector('.date-safe-end');
                    endInput.onchange = (e) => updatePhase(idx, 'endDate', new Date(e.target.value).toISOString());
                    
                    // Add blur validation for phase dates
                    const validatePhaseDates = () => {
                        if (!startInput.value || !endInput.value) {
                            return; // Skip validation if dates are not set
                        }
                        
                        const phaseStartDate = new Date(startInput.value);
                        const phaseEndDate = new Date(endInput.value);
                        
                        if (phaseStartDate > phaseEndDate) {
                            // Add error styling
                            startInput.classList.add('error');
                            endInput.classList.add('error');
                            startInput.title = 'Phase Start Date must be before End Date';
                            endInput.title = 'Phase End Date must be after Start Date';
                        } else {
                            // Remove error styling
                            startInput.classList.remove('error');
                            endInput.classList.remove('error');
                            startInput.title = 'Phase Start Date';
                            endInput.title = 'Phase End Date';
                        }
                    };
                    
                    startInput.addEventListener('blur', validatePhaseDates);
                    endInput.addEventListener('blur', validatePhaseDates);

                    tbody.appendChild(tr);
                });
            }

            function addPhase(startDate = null) {
                const start = startDate ? startDate : new Date().toISOString();
                const end = startDate ? new Date(new Date(startDate).getTime() + 864e5 * 14).toISOString() : new Date().toISOString(); // Default 2 weeks

                editingCopy.phases.push({
                    id: Date.now().toString(),
                    name: 'New Phase',
                    color: getRandomModernColor(),
                    startDate: start,
                    endDate: end,
                    status: 'pending'
                });
                renderPhases();
            }

            function updatePhase(idx, field, value) {
                const phase = editingCopy.phases[idx];
                
                // Validate dates
                if (field === 'startDate' || field === 'endDate') {
                    const startDate = field === 'startDate' ? new Date(value) : new Date(phase.startDate);
                    const endDate = field === 'endDate' ? new Date(value) : new Date(phase.endDate);
                    
                    if (startDate > endDate) {
                        alert('‚ö†Ô∏è Start Date cannot be later than End Date!\n\nPhase: ' + phase.name + '\nStart: ' + startDate.toLocaleDateString() + '\nEnd: ' + endDate.toLocaleDateString());
                        
                        // Add error class for visual feedback
                        const tbody = document.getElementById('phases-list');
                        const row = tbody.children[idx];
                        const inputs = row.querySelectorAll('input[type="date"]');
                        inputs.forEach(input => {
                            input.classList.add('error');
                            setTimeout(() => input.classList.remove('error'), 500);
                        });
                        
                        renderPhases(); // Re-render to reset the input
                        return;
                    }
                }
                
                editingCopy.phases[idx][field] = value;
            }

            function deletePhase(idx) {
                editingCopy.phases.splice(idx, 1);
                renderPhases();
            }

            // Get filtered initiatives based on the current active view
            function getFilteredInitiativesForCurrentView() {
                const initiatives = appState.initiatives;
                
                // If on timeline view, apply timeline filters
                if (appState.activeView === 'timeline') {
                    const tl = appState.timelineFilters;
                    return initiatives.filter(i => {
                        const matchName = i.name.toLowerCase().includes(tl.name.toLowerCase());
                        const matchKey = !tl.key ? true : ((i.keyInitiative === 'Yes' || (i.keyInitiative && i.keyInitiative !== 'No')));
                        const matchOwner = i.owner.toLowerCase().includes(tl.owner.toLowerCase());
                        const matchStatus = tl.status.length === 0 || tl.status.includes(i.status);
                        const matchDate = !tl.targetDate || new Date(i.targetDate) <= new Date(tl.targetDate);
                        return matchName && matchKey && matchOwner && matchStatus && matchDate;
                    });
                }
                
                // If on dashboard view, apply dashboard filters
                if (appState.activeView === 'current') {
                    return initiatives
                        .filter(i => {
                            if (appState.filterStatus === 'all') return true;
                            if (appState.filterStatus === 'active') return i.status === 'active' || i.status === 'risk';
                            if (appState.filterStatus === 'planned') return i.status && i.status.toLowerCase() === 'planned';
                            return i.status === appState.filterStatus;
                        })
                        .filter(i => appState.filterCategory === 'all' || (i.categories && i.categories.includes(appState.filterCategory)));
                }
                
                // For snapshots view or any other view, return all initiatives
                return initiatives;
            }

            async function takeSnapshot() {
  const note = document.getElementById('snap-note').value;
  
  try {
    const filteredInitiatives = getFilteredInitiativesForCurrentView();
    const snapshot = await createSnapshotInDB(note, filteredInitiatives);
    
    appState.snapshots.unshift({
      id: snapshot.id.toString(),
      date: snapshot.created_at,
      initiatives: JSON.parse(snapshot.data),
      note: snapshot.note
    });
    
    document.getElementById('snap-note').value = '';
    render();
  } catch (error) {
    console.error('Error creating snapshot:', error);
    alert('Failed to create snapshot');
  }
}

            // Check and create weekly snapshots automatically
            async function checkAndCreateWeeklySnapshot() {
                try {
                    const lastSnapshotKey = 'last_weekly_snapshot_date';
                    const lastSnapshotDate = localStorage.getItem(lastSnapshotKey);
                    const now = new Date();
                    const oneWeekMs = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
                    
                    // If no last snapshot or it's been more than a week
                    if (!lastSnapshotDate || (now.getTime() - new Date(lastSnapshotDate).getTime()) >= oneWeekMs) {
                        console.log('üì∏ Creating automatic weekly snapshot...');
                        const snapshot = await createSnapshotInDB('Automatic weekly snapshot');
                        
                        appState.snapshots.unshift({
                            id: snapshot.id.toString(),
                            date: snapshot.created_at,
                            initiatives: JSON.parse(snapshot.data),
                            note: snapshot.note
                        });
                        
                        localStorage.setItem(lastSnapshotKey, now.toISOString());
                        console.log('‚úÖ Weekly snapshot created successfully');
                        render();
                    } else {
                        const nextSnapshotDate = new Date(new Date(lastSnapshotDate).getTime() + oneWeekMs);
                        console.log(`üìÖ Next automatic snapshot: ${nextSnapshotDate.toLocaleString()}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error creating weekly snapshot:', error);
                }
            }

            function switchView(viewName) {
                appState.activeView = viewName;
                
                document.getElementById('view-current').classList.toggle('hidden', viewName !== 'current');
                document.getElementById('view-timeline').classList.toggle('hidden', viewName !== 'timeline');
                document.getElementById('view-snapshots').classList.toggle('hidden', viewName !== 'snapshots');

                document.getElementById('btn-view-current').classList.toggle('active', viewName === 'current');
                document.getElementById('btn-view-timeline').classList.toggle('active', viewName === 'timeline');
                document.getElementById('btn-view-snapshots').classList.toggle('active', viewName === 'snapshots');

                render();
            }

            function viewSnapshot(id) {
                const snap = appState.snapshots.find(s => s.id === id);
                if (!snap) return;

                const p = document.getElementById('snapshot-preview');
                p.classList.remove('hidden');
                document.getElementById('preview-meta').innerText = `${new Date(snap.date).toLocaleString()} - ${snap.note || ''}`;

                document.getElementById('s-total').innerText = snap.initiatives.length;
                document.getElementById('s-completed').innerText = snap.initiatives.filter(i => i.status === 'completed').length;
                document.getElementById('s-active').innerText = snap.initiatives.filter(i => i.status === 'active').length;
                document.getElementById('s-risk').innerText = snap.initiatives.filter(i => i.status === 'risk').length;

                // Render Read-Only Table for Snapshot
                const sTbody = document.getElementById('snapshot-table-body');
                sTbody.innerHTML = '';
                snap.initiatives.forEach(i => {
                    const tr = document.createElement('tr');
                    let phasesHtml = '';
                    if (i.phases && i.phases.length > 0) {
                        phasesHtml = `<div style="display:flex; flex-direction:column; gap:4px; margin-top:4px;">
                    ${i.phases.map(p => `
                        <div style="font-size:0.8rem; color:var(--text-secondary); display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:2px 4px; borderRadius:4px;">
                            <span>${p.name}</span>
                            <span>${new Date(p.startDate).toLocaleDateString()} - ${new Date(p.endDate).toLocaleDateString()}</span>
                        </div>
                    `).join('')}
                </div>`;
                    } else {
                        phasesHtml = `<div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">No phases defined</div>`;
                    }

                    const tagsHtml = (i.tags || []).map(t => `<span class="tag-badge">${t}</span>`).join('');

                    tr.innerHTML = `
                <td style="vertical-align:top;">
                    <strong>${i.name}</strong><br>
                    <span style="font-size:0.8rem; color:var(--text-muted)">${i.owner}</span>
                    <div style="margin-top:4px;">${tagsHtml}</div>
                </td>
                <td>
                    <div style="font-size:0.85rem;">Overall: ${new Date(i.startDate).toLocaleDateString()} - ${new Date(i.targetDate).toLocaleDateString()}</div>
                    ${phasesHtml}
                </td>
                <td style="vertical-align:top;"><span class="badge ${i.status}">${i.status}</span></td>
            `;
                    sTbody.appendChild(tr);
                });

                // Render Timeline for Snapshot
                renderTimeline(snap.initiatives, 'snapshot-timeline-rows', 'snapshot-timeline-axis', false);
            }

            function setFilter(status) {
                appState.filterStatus = status;
                appState.initiativesPage = 1; // Reset to first page when filter changes
                render();
            }

            function setCategoryFilter(category) {
                appState.filterCategory = category;
                appState.initiativesPage = 1; // Reset to first page when filter changes
                render();
                // Also re-render the initiatives list with current status filter
                const activeTab = document.querySelector('.filter-tab.active');
                let currentFilter = 'all';
                if (activeTab) {
                    const tabText = activeTab.textContent.trim().toLowerCase();
                    if (tabText === 'active') currentFilter = 'active';
                    else if (tabText === 'planned') currentFilter = 'planned';
                    else if (tabText === 'at risk') currentFilter = 'risk';
                }
                renderInitiativesList(currentFilter);
            }

            function renderCategoryFilters() {
                const container = document.getElementById('category-filters');
                if (!container) return;

                // Extract unique categories
                const categories = new Set();
                appState.initiatives.forEach(i => {
                    if (i.categories) i.categories.forEach(c => categories.add(c));
                });

                const list = ['all', ...Array.from(categories).sort()];

                container.innerHTML = list.map(cat => {
                    const count = cat === 'all'
                        ? appState.initiatives.length
                        : appState.initiatives.filter(i => i.categories && i.categories.includes(cat)).length;

                    const label = cat === 'all' ? 'All Categories' : cat;
                    const activeClass = appState.filterCategory === cat ? 'active' : '';

                    return `
                        <div class="category-pill ${activeClass}" onclick="setCategoryFilter('${cat}')">
                            ${label}
                            <span class="count">${count}</span>
                        </div>
                    `;
                }).join('');
            }

            function updateTimelineFilters(key, value) {
                // Handle boolean value for 'key' filter
                appState.timelineFilters[key] = value;
                render();
            }

            function updateTimelineStatusFilter() {
                // Collect all checked status checkboxes
                const checkboxes = document.querySelectorAll('#filter-tl-status input[type="checkbox"]');
                const selectedStatuses = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                appState.timelineFilters.status = selectedStatuses;
                render();
            }

            function clearTimelineFilters() {
                appState.timelineFilters = {
                    name: '',
                    key: false,
                    owner: '',
                    status: [],
                    targetDate: ''
                };
                // Reset UI inputs
                document.getElementById('filter-tl-name').value = '';
                document.getElementById('filter-tl-key').checked = false;
                document.getElementById('filter-tl-owner').value = '';
                // Uncheck all status checkboxes
                const statusCheckboxes = document.querySelectorAll('#filter-tl-status input[type="checkbox"]');
                statusCheckboxes.forEach(cb => cb.checked = false);
                document.getElementById('filter-tl-date').value = '';
                render();
            }

            function sortBy(key) {
                if (appState.sortKey === key) {
                    appState.sortOrder = appState.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    appState.sortKey = key;
                    appState.sortOrder = 'asc';
                }
                render();
            }

            // Calculate and render portfolio health score
            function renderPortfolioHealth(initiatives) {
                if (initiatives.length === 0) {
                    document.getElementById('m-health').innerText = '-';
                    document.getElementById('m-health-label').innerText = 'No data';
                    return;
                }
                
                const completed = initiatives.filter(i => i.status === 'completed').length;
                const active = initiatives.filter(i => i.status === 'active').length;
                const risk = initiatives.filter(i => i.status === 'risk').length;
                const planned = initiatives.filter(i => i.status === 'planned').length;
                
                // Calculate health score (0-100)
                // Formula: Base score from completion rate, penalties for at-risk initiatives
                const completionRate = (completed / initiatives.length) * 100;
                const activeRate = (active / initiatives.length) * 100;
                const riskPenalty = (risk / initiatives.length) * 50; // Risk initiatives heavily penalize health
                
                let healthScore = Math.round((completionRate * 0.4) + (activeRate * 0.4) - riskPenalty + 20);
                healthScore = Math.max(0, Math.min(100, healthScore)); // Clamp between 0-100
                
                let healthLabel = 'Poor';
                if (healthScore >= 80) healthLabel = 'Excellent';
                else if (healthScore >= 65) healthLabel = 'Good';
                else if (healthScore >= 50) healthLabel = 'Fair';
                
                document.getElementById('m-health').innerText = healthScore;
                document.getElementById('m-health-label').innerText = healthLabel;
            }
            
            // Render portfolio summary with key insights
            function renderPortfolioSummary(initiatives) {
                const container = document.getElementById('portfolio-summary');
                if (!container) return;
                
                if (initiatives.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); grid-column: 1/-1; text-align: center;">No initiatives to analyze</div>';
                    return;
                }
                
                // Calculate insights
                const now = new Date();
                const overdue = initiatives.filter(i => 
                    i.status !== 'completed' && new Date(i.targetDate) < now
                ).length;
                
                const dueThisMonth = initiatives.filter(i => {
                    if (i.status === 'completed') return false;
                    const target = new Date(i.targetDate);
                    return target.getMonth() === now.getMonth() && target.getFullYear() === now.getFullYear();
                }).length;
                
                const keyInitiatives = initiatives.filter(i => i.keyInitiative === 'Yes').length;
                
                // Calculate average lifecycle progress
                let totalProgress = 0;
                let initiativesWithPhases = 0;
                initiatives.forEach(i => {
                    if (i.phases && i.phases.length > 0) {
                        const completed = i.phases.filter(p => p.status === 'completed').length;
                        totalProgress += (completed / i.phases.length) * 100;
                        initiativesWithPhases++;
                    }
                });
                const avgProgress = initiativesWithPhases > 0 
                    ? Math.round(totalProgress / initiativesWithPhases) 
                    : 0;
                
                // Count initiatives by lifecycle stage
                const lifecycleStages = {
                    'Planning': 0,
                    'Execution': 0,
                    'Delivered': 0
                };
                
                initiatives.forEach(i => {
                    if (i.status === 'completed') {
                        lifecycleStages['Delivered']++;
                    } else if (i.status === 'planned') {
                        lifecycleStages['Planning']++;
                    } else {
                        lifecycleStages['Execution']++;
                    }
                });
                
                container.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">‚è∞</span>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: ${overdue > 0 ? 'var(--risk-color)' : 'var(--success-color)'};">${overdue}</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Overdue</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">üìÖ</span>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-color);">${dueThisMonth}</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Due This Month</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">üîë</span>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);">${keyInitiatives}</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Key Initiatives</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">üìä</span>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--purple);">${avgProgress}%</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Avg Progress</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; grid-column: span 2;">
                        <span style="font-size: 1.5rem;">üéØ</span>
                        <div style="flex: 1;">
                            <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">Lifecycle Distribution</div>
                            <div style="display: flex; gap: 0.5rem; font-size: 0.875rem;">
                                <span>üìã Planning: <strong>${lifecycleStages['Planning']}</strong></span>
                                <span>üöÄ Execution: <strong>${lifecycleStages['Execution']}</strong></span>
                                <span>‚úÖ Delivered: <strong>${lifecycleStages['Delivered']}</strong></span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- RENDER ---
            function render() {
                const initiatives = appState.initiatives;

                // 1. Metrics & Filters
                renderCategoryFilters();

                document.getElementById('m-total').innerText = initiatives.length;
                document.getElementById('m-completed').innerText = initiatives.filter(i => i.status === 'completed').length;
                document.getElementById('m-active').innerText = initiatives.filter(i => i.status === 'active' || i.status === 'risk').length;
                document.getElementById('m-planned').innerText = initiatives.filter(i => i.status && i.status.toLowerCase() === 'planned').length;
                document.getElementById('m-risk').innerText = initiatives.filter(i => i.status === 'risk').length;
                
                // Calculate Portfolio Health Score
                renderPortfolioHealth(initiatives);
                
                // Render Portfolio Summary
                renderPortfolioSummary(initiatives);

                // Update Active Filter Class
                ['all', 'completed', 'active', 'planned', 'risk'].forEach(s => {
                    const el = document.getElementById(`filter-${s}`);
                    if (el) el.classList.toggle('active', appState.filterStatus === s);
                });

                // Update Table Header Sort Indicators
                ['id', 'name', 'owner', 'keyInitiative', 'targetDate', 'status'].forEach(k => {
                    const el = document.getElementById(`header-${k}`);
                    if (el) {
                        el.classList.remove('asc', 'desc');
                        if (appState.sortKey === k) {
                            el.classList.add(appState.sortOrder);
                        }
                    }
                });

                // 2. Table (Filtered & Sorted)
                let filteredInitiatives = initiatives
                    .filter(i => {
                        if (appState.filterStatus === 'all') return true;
                        if (appState.filterStatus === 'active') return i.status === 'active' || i.status === 'risk';
                        if (appState.filterStatus === 'planned') return i.status && i.status.toLowerCase() === 'planned';
                        return i.status === appState.filterStatus;
                    })
                    .filter(i => appState.filterCategory === 'all' || (i.categories && i.categories.includes(appState.filterCategory)));

                // Apply Sort
                filteredInitiatives.sort((a, b) => {
                    // First, prioritize keyInitiative (true comes before false/undefined)
                    const aIsKey = a.keyInitiative === 'Yes' || (a.keyInitiative && a.keyInitiative !== 'No');
                    const bIsKey = b.keyInitiative === 'Yes' || (b.keyInitiative && b.keyInitiative !== 'No');
                    
                    if (aIsKey !== bIsKey) {
                        return aIsKey ? -1 : 1;  // key initiatives first
                    }
                    
                    // Then apply the regular sort by the selected column
                    let valA = a[appState.sortKey];
                    let valB = b[appState.sortKey];

                    // Handle string casing and dates
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();

                    if (valA < valB) return appState.sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return appState.sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

                const tbody = document.getElementById('table-body');
                if (!tbody) {
                    // Table was removed, skip table rendering
                    console.log('Table body element not found, skipping table render');
                } else {
                    tbody.innerHTML = '';
                    if (filteredInitiatives.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--text-muted)">No ${appState.filterStatus === 'all' ? '' : appState.filterStatus} initiatives found.</td></tr>`;
                        if (initiatives.length === 0) {
                            const btnSeed = document.getElementById('btn-seed');
                            if (btnSeed) btnSeed.classList.remove('hidden');
                        }
                    } else {
                        const btnSeed = document.getElementById('btn-seed');
                        if (btnSeed) btnSeed.classList.add('hidden');
                    }

                filteredInitiatives.forEach(i => {
                    const tr = document.createElement('tr');
                    tr.className = 'clickable';
                    tr.onclick = () => openModal(i.id);

                    const categoriesHtml = (i.categories || []).map(c => `<span style="font-size: 0.65rem; background:rgba(14, 165, 233, 0.1); color:var(--accent-color); border:1px solid rgba(14, 165, 233, 0.3); padding:1px 6px; border-radius:4px; margin-right:4px; display:inline-block;">${c}</span>`).join('');
                    const tagsHtml = (i.tags || []).map(t => `<span class="tag-badge">${t}</span>`).join('');
                    const domain = localStorage.getItem('jira_domain') || 'your-domain.atlassian.net';
                    const jiraLink = `https://${domain}/browse/${i.id}`;

                    tr.innerHTML = `
                <td><a href="${jiraLink}" target="_blank" onclick="event.stopPropagation();" style="color:var(--accent-color); text-decoration:none; font-weight:bold;">${i.id}</a></td>
                <td style="font-weight:500;">
                   <div style="display:flex; gap:0.5rem; align-items:center;">
                        ${i.name}
                        ${(i.phases && i.phases.length > 0) ? '<span style="font-size:0.7rem; background:rgba(255,255,255,0.1); padding:2px 6px; borderRadius:4px">' + i.phases.length + ' Phases</span>' : ''}
                   </div>
                   <div style="margin-top: 4px;">${categoriesHtml} ${tagsHtml}</div>
                </td>
                <td style="color:var(--text-secondary)">${i.owner}</td>
                <td style="text-align: center; font-size: 1.2rem;">${(i.keyInitiative === 'Yes' || (i.keyInitiative && i.keyInitiative !== 'No')) ? 'üö©' : ''}</td>
                <td>${new Date(i.targetDate).toLocaleDateString()}</td>
                <td><span class="badge ${i.status}">${i.status}</span></td>
            `;
                    if (i.keyInitiative === 'Yes' || (i.keyInitiative && i.keyInitiative !== 'No')) tr.classList.add('key-initiative');
                    tbody.appendChild(tr);
                });
                } // End table rendering if check

                // 3. Timeline (with its own filters)
                const tl = appState.timelineFilters;
                const filteredForTimeline = initiatives.filter(i => {
                    const matchName = i.name.toLowerCase().includes(tl.name.toLowerCase());
                    const matchKey = !tl.key ? true : ((i.keyInitiative === 'Yes' || (i.keyInitiative && i.keyInitiative !== 'No')));
                    const matchOwner = i.owner.toLowerCase().includes(tl.owner.toLowerCase());
                    const matchStatus = tl.status.length === 0 || tl.status.includes(i.status);
                    const matchDate = !tl.targetDate || new Date(i.targetDate) <= new Date(tl.targetDate);
                    return matchName && matchKey && matchOwner && matchStatus && matchDate;
                });

                renderTimeline(filteredForTimeline, 'timeline-rows', 'timeline-axis', true);

                // 4. Snapshots List
                const snapList = document.getElementById('snapshot-list');
                snapList.innerHTML = '';
                appState.snapshots.forEach(s => {
                    const btn = document.createElement('button');
                    btn.className = 'badge planned';
                    btn.style.cursor = 'pointer';
                    btn.style.marginRight = '5px';
                    btn.innerText = new Date(s.date).toLocaleDateString();
                    btn.onclick = () => viewSnapshot(s.id);
                    snapList.appendChild(btn);
                });
                
                // 5. Render Design 1 Components
                renderInitiativesList('all');
                renderUpcomingMilestones();
                renderRecentActivity();
            }

            // --- NEW DESIGN 1 FUNCTIONS ---
            
            // Render Initiatives List
            function renderInitiativesList(filter = 'all') {
                const initiatives = appState.initiatives;
                const container = document.getElementById('initiative-list');
                
                let filtered = initiatives;
                if (filter !== 'all') {
                    if (filter === 'active') {
                        // Active filter includes both active and risk status
                        filtered = initiatives.filter(i => i.status === 'active' || i.status === 'risk');
                    } else {
                        filtered = initiatives.filter(i => i.status === filter);
                    }
                }
                
                // Apply category filter
                if (appState.filterCategory && appState.filterCategory !== 'all') {
                    filtered = filtered.filter(i => i.categories && i.categories.includes(appState.filterCategory));
                }
                
                // Sort by Key Initiative first (Key Initiatives on top), then by target date (upcoming first)
                filtered.sort((a, b) => {
                    const aIsKey = a.keyInitiative === 'Yes';
                    const bIsKey = b.keyInitiative === 'Yes';
                    
                    // If one is key initiative and other is not, key initiative comes first
                    if (aIsKey && !bIsKey) return -1;
                    if (!aIsKey && bIsKey) return 1;
                    
                    // If both are same type (both key or both not key), sort by target date
                    return new Date(a.targetDate) - new Date(b.targetDate);
                });
                
                if (filtered.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted)">No initiatives found</div>';
                    document.getElementById('initiatives-pagination').innerHTML = '';
                    return;
                }
                
                // Calculate pagination
                const totalItems = filtered.length;
                const totalPages = Math.ceil(totalItems / appState.initiativesPerPage);
                
                // Ensure current page is valid
                if (appState.initiativesPage > totalPages && totalPages > 0) {
                    appState.initiativesPage = 1;
                }
                
                const currentPage = appState.initiativesPage;
                
                // Get items for current page
                const startIndex = (currentPage - 1) * appState.initiativesPerPage;
                const endIndex = startIndex + appState.initiativesPerPage;
                const paginatedItems = filtered.slice(startIndex, endIndex);
                
                container.innerHTML = paginatedItems.map(i => {
                    const targetDate = new Date(i.targetDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const isKey = i.keyInitiative === 'Yes';
                    
                    let badgeClass = 'badge-active';
                    if (i.status === 'planned') badgeClass = 'badge-planned';
                    if (i.status === 'risk') badgeClass = 'badge-risk';
                    if (i.status === 'completed') badgeClass = 'badge-completed';
                    
                    // Format categories for display
                    const categoriesHtml = i.categories && i.categories.length > 0 
                        ? `<span>üè∑Ô∏è ${i.categories.join(', ')}</span>`
                        : '<span>üè∑Ô∏è No categories</span>';
                    
                    // Calculate progress based on phases
                    let progress = 0;
                    let currentPhaseInfo = '';
                    let lifecycleStage = 'Planning';
                    
                    if (i.status === 'completed') {
                        progress = 100;
                        lifecycleStage = 'Delivered';
                    } else if (i.phases && i.phases.length > 0) {
                        const completedPhases = i.phases.filter(p => p.status === 'completed').length;
                        progress = Math.round((completedPhases / i.phases.length) * 100);
                        
                        // Find current active phase
                        const now = new Date();
                        const activePhase = i.phases.find(p => {
                            const start = new Date(p.startDate);
                            const end = new Date(p.endDate);
                            return start <= now && now <= end && p.status !== 'completed';
                        });
                        
                        if (activePhase) {
                            const daysInPhase = Math.floor((now - new Date(activePhase.startDate)) / (1000 * 60 * 60 * 24));
                            currentPhaseInfo = `üìç ${activePhase.name} (Day ${daysInPhase})`;
                            lifecycleStage = activePhase.name;
                        } else {
                            // Find next upcoming phase
                            const upcomingPhase = i.phases.find(p => new Date(p.startDate) > now && p.status !== 'completed');
                            if (upcomingPhase) {
                                currentPhaseInfo = `‚è≠Ô∏è Next: ${upcomingPhase.name}`;
                                lifecycleStage = upcomingPhase.name;
                            } else if (completedPhases > 0) {
                                lifecycleStage = 'Execution';
                            }
                        }
                    } else {
                        // No phases defined - use status to determine stage
                        if (i.status === 'planned') {
                            lifecycleStage = 'Planning';
                        } else if (i.status === 'active' || i.status === 'risk') {
                            lifecycleStage = 'Execution';
                            // Calculate basic progress based on time elapsed
                            const start = new Date(i.startDate);
                            const end = new Date(i.targetDate);
                            const now = new Date();
                            const total = end - start;
                            const elapsed = now - start;
                            progress = Math.min(100, Math.max(0, Math.round((elapsed / total) * 100)));
                        }
                    }
                    
                    const progressBarClass = i.status === 'completed' ? 'completed' : (i.status === 'risk' ? 'risk' : '');
                    
                    return `
                        <div class="initiative-item" onclick="openModal('${i.id}')" tabindex="0" role="button" onkeypress="if(event.key==='Enter'||event.key===' ')openModal('${i.id}')">
                            <div class="initiative-content">
                                <div class="initiative-title">
                                    ${i.name}
                                    <span class="lifecycle-stage">${lifecycleStage}</span>
                                </div>
                                <div class="initiative-meta">
                                    ${categoriesHtml}
                                    <span>üìÖ Due ${targetDate}</span>
                                    ${isKey ? '<span>üîë Key Initiative</span>' : ''}
                                </div>
                                ${currentPhaseInfo ? `<div class="phase-info">${currentPhaseInfo}</div>` : ''}
                                <div class="initiative-progress">
                                    <div class="initiative-progress-bar ${progressBarClass}" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <span class="initiative-badge ${badgeClass}">${i.status.charAt(0).toUpperCase() + i.status.slice(1)}</span>
                        </div>
                    `;
                }).join('');
                
                // Render pagination controls
                renderPaginationControls(totalItems, totalPages, filter);
            }
            
            // Render Pagination Controls
            function renderPaginationControls(totalItems, totalPages, filter) {
                const container = document.getElementById('initiatives-pagination');
                
                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                // Sanitize filter to prevent XSS - only allow known filter values
                const validFilters = ['all', 'active', 'planned', 'risk', 'completed'];
                const safeFilter = validFilters.includes(filter) ? filter : 'all';
                
                const currentPage = appState.initiativesPage;
                const startItem = (currentPage - 1) * appState.initiativesPerPage + 1;
                const endItem = Math.min(currentPage * appState.initiativesPerPage, totalItems);
                
                let html = '';
                
                // Previous button
                html += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1}, '${safeFilter}')" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>`;
                
                // Page numbers
                const maxPageButtons = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
                let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
                
                // Adjust startPage if we're near the end
                if (endPage - startPage < maxPageButtons - 1) {
                    startPage = Math.max(1, endPage - maxPageButtons + 1);
                }
                
                // First page
                if (startPage > 1) {
                    html += `<button class="pagination-btn" onclick="goToPage(1, '${safeFilter}')">1</button>`;
                    if (startPage > 2) {
                        html += `<span class="pagination-info">...</span>`;
                    }
                }
                
                // Page number buttons
                for (let i = startPage; i <= endPage; i++) {
                    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i}, '${safeFilter}')">${i}</button>`;
                }
                
                // Last page
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        html += `<span class="pagination-info">...</span>`;
                    }
                    html += `<button class="pagination-btn" onclick="goToPage(${totalPages}, '${safeFilter}')">${totalPages}</button>`;
                }
                
                // Next button
                html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1}, '${safeFilter}')" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>`;
                
                // Info text
                html += `<span class="pagination-info">Showing ${startItem}-${endItem} of ${totalItems}</span>`;
                
                container.innerHTML = html;
            }
            
            // Go to specific page
            function goToPage(page, filter) {
                appState.initiativesPage = page;
                renderInitiativesList(filter);
            }
            
            // Render Upcoming Milestones
            function renderUpcomingMilestones() {
                const initiatives = appState.initiatives;
                const container = document.getElementById('upcoming-milestones');
                
                // Get upcoming initiatives (only future dates) sorted by target date
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Set to start of day for comparison
                
                const upcoming = initiatives
                    .filter(i => {
                        const targetDate = new Date(i.targetDate);
                        return i.status !== 'completed' && targetDate >= today;
                    })
                    .sort((a, b) => new Date(a.targetDate) - new Date(b.targetDate))
                    .slice(0, 5);
                
                if (upcoming.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.875rem">No upcoming milestones</div>';
                    return;
                }
                
                container.innerHTML = upcoming.map(i => {
                    const date = new Date(i.targetDate);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    let detail = i.status === 'risk' ? 'At Risk' : 
                                i.status === 'active' ? 'In Progress' : 
                                'Planned';
                    
                    // Get upcoming phases for this initiative
                    let phasesHtml = '';
                    if (i.phases && i.phases.length > 0) {
                        const upcomingPhases = i.phases
                            .filter(p => {
                                const phaseEnd = new Date(p.endDate);
                                return phaseEnd >= today;
                            })
                            .sort((a, b) => new Date(a.endDate) - new Date(b.endDate))
                            .slice(0, 3); // Show max 3 upcoming phases
                        
                        if (upcomingPhases.length > 0) {
                            phasesHtml = '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color); font-size: 0.75rem;">';
                            phasesHtml += upcomingPhases.map(phase => {
                                const phaseEndDate = new Date(phase.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                let phaseIcon = '‚è≥';
                                if (phase.status === 'completed') phaseIcon = '‚úÖ';
                                else if (phase.status === 'active') phaseIcon = 'üîÑ';
                                return `<div style="margin: 0.25rem 0; color: var(--text-secondary);">${phaseIcon} ${phase.name} - ${phaseEndDate}</div>`;
                            }).join('');
                            phasesHtml += '</div>';
                        }
                    }
                    
                    return `
                        <div class="timeline-item" onclick="openModal('${i.id}')" style="cursor:pointer;">
                            <div class="timeline-date">${dateStr}</div>
                            <div class="timeline-content">
                                <div class="timeline-title">${i.name}</div>
                                <div class="timeline-detail">${detail}</div>
                                ${phasesHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render Recent Activity
            async function renderRecentActivity() {
                const container = document.getElementById('recent-activity');
                
                try {
                    // Fetch activities from database
                    const activities = await getAllActivitiesFromDB();
                    
                    if (activities.length === 0) {
                        container.innerHTML = `
                            <div class="activity-item">
                                <div class="activity-icon">üìä</div>
                                <div class="activity-content">
                                    <div class="activity-text">Portfolio tracker initialized</div>
                                    <div class="activity-meta">System ‚Ä¢ Today</div>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Display up to 10 activities (database query already limits to 10)
                    container.innerHTML = activities.map(a => {
                        const activityDate = new Date(a.timestamp);
                        const relativeTime = getRelativeTime(activityDate);
                        return `
                            <div class="activity-item">
                                <div class="activity-icon">${a.icon}</div>
                                <div class="activity-content">
                                    <div class="activity-text">${a.text}</div>
                                    <div class="activity-meta">${a.meta} ‚Ä¢ ${relativeTime}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Failed to load activities:', error);
                    container.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-icon">‚ö†Ô∏è</div>
                            <div class="activity-content">
                                <div class="activity-text">Failed to load activities</div>
                                <div class="activity-meta">System ‚Ä¢ Error</div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Helper function for relative time
            function getRelativeTime(date) {
                const now = Date.now();
                const diff = now - date;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (hours < 1) return 'Just now';
                if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                if (days === 1) return '1 day ago';
                if (days < 7) return `${days} days ago`;
                return date.toLocaleDateString();
            }
            
            // Filter initiatives in Initiatives card
            function filterInitiatives(filter) {
                // Update active tab
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    const tabText = tab.textContent.trim().toLowerCase();
                    const isActive = tabText === filter || 
                        (filter === 'all' && tab.textContent.trim() === 'All') ||
                        (filter === 'risk' && tabText === 'at risk');
                    tab.classList.toggle('active', isActive);
                });
                
                // Reset to first page when filter changes
                appState.initiativesPage = 1;
                renderInitiativesList(filter);
            }
            
            // Add Note function
            function addNote() {
                if (!editingId) return;
                
                const noteInput = document.getElementById('note-input');
                const noteText = noteInput.value.trim();
                
                if (!noteText) return;
                
                const initiative = appState.initiatives.find(i => i.id === editingId);
                if (!initiative) return;
                
                if (!initiative.notes) {
                    initiative.notes = [];
                }
                
                // Also ensure editingCopy has notes array
                if (!editingCopy.notes) {
                    editingCopy.notes = [];
                }
                
                const note = {
                    id: Date.now(),
                    text: noteText,
                    author: initiative.owner || 'User',
                    date: new Date().toISOString()
                };
                
                initiative.notes.push(note);
                // Also add to editingCopy so it gets saved to DB
                editingCopy.notes.push(note);
                noteInput.value = '';
                
                // Log activity for note added
                saveActivityToDB({
                    type: 'note_added',
                    icon: 'üí¨',
                    text: `Added note to ${initiative.name}`,
                    meta: note.author, // Store only author, compute relative time at display
                    timestamp: new Date().toISOString(),
                    initiativeId: initiative.id,
                    initiativeName: initiative.name
                }).catch(err => console.error('Failed to log note activity:', err));
                
                renderNotes();
                saveContext(); // Auto-save
            }
            
            // Render Notes in Modal
            function renderNotes() {
                if (!editingId) return;
                
                const initiative = appState.initiatives.find(i => i.id === editingId);
                if (!initiative) return;
                
                const notesSection = document.getElementById('notes-section');
                const notesList = document.getElementById('notes-list');
                
                // Show notes section only for at-risk initiatives
                if (initiative.status === 'risk') {
                    notesSection.style.display = 'block';
                    
                    if (!initiative.notes || initiative.notes.length === 0) {
                        notesList.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.875rem">No notes yet</div>';
                    } else {
                        // Sort notes by date descending (newest first)
                        const sortedNotes = initiative.notes.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
                        notesList.innerHTML = sortedNotes.map(note => {
                            const date = new Date(note.date).toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            return `
                                <div class="note-item">
                                    <div class="note-text">${note.text}</div>
                                    <div class="note-meta">${note.author} ‚Ä¢ ${date}</div>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    notesSection.style.display = 'none';
                }
            }

            // --- DRAG HANDLERS ---

            // Attach global listeners for drag stability (leave track)
            document.addEventListener('mousemove', (e) => {
                if (!dragData.active) return;
                e.preventDefault();

                const deltaX = e.clientX - dragData.startX;
                const msDelta = deltaX * dragData.msPerPixel;

                // Visualize: Update element position directly for performance
                dragData.element.style.transform = `translateX(${deltaX}px)`;
                dragData.element.style.zIndex = 1000;
            });

          document.addEventListener('mouseup', async (e) => {
  if (!dragData.active) return;

  const deltaX = e.clientX - dragData.startX;
  if (Math.abs(deltaX) > 2) {
    const msDelta = deltaX * dragData.msPerPixel;
    const newStart = dragData.originalStart + msDelta;
    const newEnd = dragData.originalEnd + msDelta;

    const init = appState.initiatives.find(i => i.id === dragData.initiativeId);
    if (init) {
      const phase = init.phases.find(p => p.id === dragData.phaseId);
      if (phase) {
        phase.startDate = new Date(newStart).toISOString();
        phase.endDate = new Date(newEnd).toISOString();
        
        await saveInitiativeToDB(init);
        render();
      }
    }
  }

  dragData.active = false;
  if (dragData.element) {
    dragData.element.style.transform = 'none';
    dragData.element.classList.remove('dragging');
    dragData.element = null;
  }
});


            // --- ENHANCED TIMELINE LOGIC ---
            function renderTimeline(initiatives, containerId, axisId, isInteractive) {
                if (initiatives.length === 0) return;

                // 1. Calculate Range
                const dates = initiatives.flatMap(i => [
                    new Date(i.startDate).getTime(),
                    new Date(i.targetDate).getTime(),
                    ...(i.phases || []).flatMap(p => [new Date(p.startDate).getTime(), new Date(p.endDate).getTime()])
                ]);

                // Compute minDate from actual data instead of hardcoding to 2026
                let computedMinDate = Math.min(...dates);
                // Fallback to current date if computed minDate is invalid (NaN or infinite)
                if (!isFinite(computedMinDate)) {
                    computedMinDate = new Date().getTime();
                }
                // Normalize to first day of month at 00:00
                let minD = new Date(computedMinDate);
                minD.setDate(1);
                minD.setHours(0, 0, 0, 0);
                let minDate = minD.getTime();

                let maxD = new Date(Math.max(...dates, new Date(new Date().getFullYear(), 11, 31).getTime()));
                maxD.setMonth(maxD.getMonth() + 1);
                maxD.setDate(0); // End of month
                let maxDate = maxD.getTime();
                
                // Guard: if minDate >= maxDate, shift minDate back by 3 months
                if (minDate >= maxDate) {
                    minD.setMonth(minD.getMonth() - 3);
                    minDate = minD.getTime();
                }
                
                const totalMs = maxDate - minDate;

                // 2. Render Axis
                const axis = document.getElementById(axisId);
                axis.innerHTML = '';

                let currentTick = new Date(minDate);
                while (currentTick.getTime() <= maxDate) {
                    const tickTime = currentTick.getTime();
                    const pct = ((tickTime - minDate) / totalMs) * 100;
                    const tick = document.createElement('div');
                    tick.style.position = 'absolute';
                    tick.style.left = pct + '%';
                    tick.style.top = '0';
                    tick.style.fontSize = '0.7rem';
                    tick.style.color = 'var(--text-muted)';
                    tick.style.transform = 'translateX(-50%)';
                    tick.style.whiteSpace = 'nowrap';
                    tick.innerText = currentTick.toLocaleDateString(undefined, { month: 'short', year: '2-digit' });

                    const mark = document.createElement('div');
                    mark.style.position = 'absolute';
                    mark.style.left = pct + '%';
                    mark.style.bottom = '-4px';
                    mark.style.height = '4px';
                    mark.style.borderLeft = '1px solid var(--border-color)';

                    axis.appendChild(tick);
                    axis.appendChild(mark);

                    // Increment to next month
                    currentTick.setMonth(currentTick.getMonth() + 1);
                }


                // 3. Render Rows
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                initiatives.forEach(i => {
                    const startPct = ((new Date(i.startDate).getTime() - minDate) / totalMs) * 100;
                    const widthPct = ((new Date(i.targetDate).getTime() - new Date(i.startDate).getTime()) / totalMs) * 100;

                    const row = document.createElement('div');
                    row.className = 'timeline-row';
                    row.style.alignItems = 'flex-start';

                    // Label
                    const label = document.createElement('div');
                    label.className = 'timeline-label';
                    label.innerText = i.name;
                    label.style.paddingTop = '8px';
                    row.appendChild(label);

                    // -- LANE LOGIC --
                    const sortedPhases = (i.phases || []).slice().sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    const lanes = [];
                    const phaseWithLanes = sortedPhases.map(p => {
                        const pStart = new Date(p.startDate).getTime();
                        const pEnd = new Date(p.endDate).getTime();
                        let laneIndex = -1;
                        for (let l = 0; l < lanes.length; l++) {
                            if (pStart >= lanes[l]) {
                                laneIndex = l;
                                lanes[l] = pEnd;
                                break;
                            }
                        }
                        if (laneIndex === -1) {
                            laneIndex = lanes.length;
                            lanes.push(pEnd);
                        }
                        return { ...p, laneIndex, _start: pStart, _end: pEnd };
                    });

                    const totalLanes = Math.max(1, lanes.length);
                    const trackHeight = (totalLanes * LANE_HEIGHT) + 10;

                    // Track
                    const track = document.createElement('div');
                    track.className = 'timeline-track';
                    track.style.height = `${trackHeight}px`;

                    if (isInteractive) {
                        track.style.cursor = 'crosshair';
                        track.title = 'Click to add phase at this date';

                        track.onclick = (e) => {
                            // Only trigger if not ending a drag
                            if (!dragData.active) {
                                const rect = track.getBoundingClientRect();
                                const x = e.clientX - rect.left;
                                const width = rect.width;
                                const pct = x / width;
                                const clickedTime = minDate + (pct * totalMs);

                                openModal(i.id);
                                addPhase(new Date(clickedTime).toISOString());
                            }
                        };
                    }

                    if (i.phases && i.phases.length > 0) {
                        // Dim background
                        const totalBar = document.createElement('div');
                        totalBar.className = 'timeline-bar';
                        totalBar.style.left = `${startPct}%`;
                        totalBar.style.width = `${widthPct}%`;
                        totalBar.style.top = '5px';
                        totalBar.style.height = `${(totalLanes * LANE_HEIGHT) - BAR_GAP}px`;
                        totalBar.style.backgroundColor = 'var(--bg-card)';
                        totalBar.style.opacity = '0.3';
                        totalBar.style.pointerEvents = 'none';
                        track.appendChild(totalBar);

                        phaseWithLanes.forEach(phase => {
                            const pLeft = ((phase._start - minDate) / totalMs) * 100;
                            const pWidth = ((phase._end - phase._start) / totalMs) * 100;
                            const pColor = phase.color || PHASE_COLORS[phase.name] || PHASE_COLORS[phase.name.split(' ')[0]] || DEFAULT_PHASE_COLOR;
                            const pTop = 5 + (phase.laneIndex * LANE_HEIGHT);

                            const bar = document.createElement('div');
                            bar.className = 'timeline-bar';
                            bar.style.left = `${pLeft}%`;
                            bar.style.width = `${pWidth}%`;
                            bar.style.top = `${pTop}px`;
                            bar.style.height = `${BAR_HEIGHT}px`;
                            bar.style.backgroundColor = pColor;
                            bar.title = `${phase.name}: ${new Date(phase.startDate).toLocaleDateString()} - ${new Date(phase.endDate).toLocaleDateString()}`;
                            
                            // Store phase data for risk detection
                            bar.dataset.phaseStatus = phase.status || 'pending';
                            bar.dataset.phaseEndDate = phase.endDate;
                            bar.dataset.phaseName = phase.name;

                            // Label inside bar
                            bar.innerText = phase.name;
                            bar.style.color = 'white';
                            bar.style.fontSize = '0.65rem';
                            bar.style.display = 'flex';
                            bar.style.alignItems = 'center';
                            bar.style.paddingLeft = '4px';
                            bar.style.overflow = 'hidden';
                            bar.style.whiteSpace = 'nowrap';
                            bar.style.textShadow = '0 1px 2px rgba(0,0,0,0.5)';

                            if (isInteractive) {
                                // Click to Edit
                                bar.onclick = (e) => {
                                    e.stopPropagation();
                                    if (!dragData.active) openModal(i.id);
                                }

                                // Drag Start
                                bar.onmousedown = (e) => {
                                    if (e.button !== 0) return; // Only left click
                                    e.stopPropagation();

                                    dragData.active = true;
                                    dragData.phaseId = phase.id;
                                    dragData.initiativeId = i.id;
                                    dragData.startX = e.clientX;
                                    dragData.originalStart = phase._start;
                                    dragData.originalEnd = phase._end;
                                    dragData.element = bar;

                                    // Calculate MS per pixel for this specific track row at this moment
                                    const rect = track.getBoundingClientRect();
                                    dragData.msPerPixel = totalMs / rect.width;

                                    bar.classList.add('dragging');
                                };
                            } else {
                                bar.style.cursor = 'default';
                            }
                            track.appendChild(bar);
                        });

                    } else {
                        // Fallback single bar
                        let color = 'var(--text-muted)';
                        if (i.status === 'active') color = 'var(--accent-color)';
                        if (i.status === 'completed') color = 'var(--success-color)';
                        if (i.status === 'risk') color = 'var(--risk-color)';

                        const bar = document.createElement('div');
                        bar.className = 'timeline-bar';
                        bar.style.left = `${startPct}%`;
                        bar.style.width = `${widthPct}%`;
                        bar.style.top = '5px';
                        bar.style.height = `${BAR_HEIGHT}px`;
                        bar.style.backgroundColor = color;
                        bar.style.pointerEvents = 'none'; // Click through to track
                        track.appendChild(bar);
                    }

                    row.appendChild(track);
                    container.appendChild(row);
                });
				if (isInteractive) {
        addTimelineRiskIndicators();
    }
				
				
				// ADD THESE TWO LINES AT THE END:
    addRiskIndicators();
    setTimeout(addTimelineRiskIndicators, 100); // Small delay to ensure timeline is rendered

            }

            // --- JIRA INTEGRATION & INIT ---



            async function checkDatabase() {
                const statusDiv = document.getElementById('sync-status');
                try {
                    statusDiv.innerText = 'Checking database...';
                    statusDiv.style.color = 'var(--text-muted)';
                    
                    // Check if IndexedDB is available
                    if (!window.indexedDB) {
                        statusDiv.innerText = '‚ùå IndexedDB not supported in this browser';
                        statusDiv.style.color = 'var(--danger-color)';
                        return;
                    }
                    
                    // Check if database exists and has data
                    if (!db) {
                        await initDB();
                    }
                    
                    const initiatives = await getAllInitiatives();
                    const snapshots = await getAllSnapshotsFromDB();
                    
                    console.log('üìä Database Status:', {
                        dbName: db.name,
                        version: db.version,
                        initiatives: initiatives.length,
                        snapshots: snapshots.length,
                        stores: Array.from(db.objectStoreNames)
                    });
                    
                    statusDiv.innerText = `‚úÖ DB OK: ${initiatives.length} initiatives, ${snapshots.length} snapshots`;
                    statusDiv.style.color = 'var(--success-color)';
                    
                    // Also check localStorage
                    console.log('üíæ LocalStorage:', {
                        domain: localStorage.getItem('jira_domain'),
                        email: localStorage.getItem('jira_email'),
                        hasToken: !!localStorage.getItem('jira_token'),
                        jql: localStorage.getItem('jira_jql')
                    });
                    
                } catch (error) {
                    console.error('Database check failed:', error);
                    statusDiv.innerText = '‚ùå Database error: ' + error.message;
                    statusDiv.style.color = 'var(--danger-color)';
                }
            }

            function openSettings() {
                document.getElementById('jira-domain').value = localStorage.getItem('jira_domain') || '';
                document.getElementById('jira-email').value = localStorage.getItem('jira_email') || '';
                document.getElementById('jira-token').value = localStorage.getItem('jira_token') || '';
                document.getElementById('jira-jql').value = localStorage.getItem('jira_jql') || 'project in ("IT Portfolio") and "Technology Squad[Dropdown]" in ("Platform Development & Integration")';
                document.getElementById('settings-modal').classList.remove('hidden');
                document.getElementById('sync-status').innerText = '';
                
                // Update storage status indicators
                updateStorageStatus();
            }

            function closeSettings() {
                document.getElementById('settings-modal').classList.add('hidden');
            }


            function clearData() {
                if (confirm('Are you sure you want to delete all local data? This cannot be undone.')) {
                    // Clear IndexedDB
                    indexedDB.deleteDatabase('InitiativeTrackerDB');
                    
                    // Clear localStorage
                    localStorage.removeItem('jira_domain');
                    localStorage.removeItem('jira_email');
                    localStorage.removeItem('jira_token');
                    localStorage.removeItem('jira_jql');
                    localStorage.removeItem('retro_astro_initiatives_vanilla');
                    localStorage.removeItem('retro_astro_snapshots_vanilla');
                    
                    alert('All data cleared! The page will reload.');
                    location.reload();
                }
            }

            /**
             * Merge JIRA data with existing Supabase/IndexedDB data
             * Preserves user-modified fields while updating JIRA-sourced fields
             * 
             * @param {Object} jiraData - Initiative data from JIRA sync
             * @param {Object|null} existingData - Existing initiative data from database, or null for new initiatives
             * @returns {Object} Merged initiative object
             * 
             * Merge Strategy:
             * - New initiatives (existingData is null): Return jiraData as-is
             * - Existing initiatives: Intelligent merge
             * 
             * Fields UPDATED from JIRA (source of truth):
             * - id, name, owner, status, startDate, targetDate, keyInitiative
             * 
             * Fields PRESERVED from existing data (user modifications):
             * - phases: User-defined project milestones with dates
             * - tags: User-defined tags
             * - created_at: Original creation timestamp
             * 
             * Fields MERGED (combine both sources):
             * - categories: Combines JIRA categories (from Technology Squad) with manually added categories
             *   Uses Set to deduplicate - prevents duplicate entries
             */
            function mergeInitiativeData(jiraData, existingData) {
                if (!existingData) {
                    // New initiative, return JIRA data as-is
                    return jiraData;
                }
                
                // Merge categories: combine JIRA categories with existing ones (deduplicate)
                const mergedCategories = [...new Set([
                    ...(existingData.categories || []),
                    ...(jiraData.categories || [])
                ])];
                
                // Return merged data:
                // - Update fields from JIRA: id, name, owner, status, keyInitiative
                // - Preserve from existing: phases, tags, dates (startDate, targetDate)
                // - Merge: categories
                return {
                    ...jiraData,
                    startDate: existingData.startDate || jiraData.startDate, // Preserve manually edited dates
                    targetDate: existingData.targetDate || jiraData.targetDate, // Preserve manually edited dates
                    categories: mergedCategories,
                    tags: existingData.tags || [],
                    phases: existingData.phases || [],
                    created_at: existingData.created_at // Preserve original creation time
                };
            }

            async function syncJira() {
    const domain = document.getElementById('jira-domain').value.replace('https://', '').replace(/\/.*/, '');
    const email = document.getElementById('jira-email').value;
    const token = document.getElementById('jira-token').value;
    const jql = document.getElementById('jira-jql').value;
    const statusDiv = document.getElementById('sync-status');

    if (!domain || !email || !token) {
        statusDiv.innerText = 'Error: Missing fields';
        statusDiv.style.color = 'var(--danger-color)';
        return;
    }

    localStorage.setItem('jira_domain', domain);
    localStorage.setItem('jira_email', email);
    localStorage.setItem('jira_token', token);
    localStorage.setItem('jira_jql', jql);

    statusDiv.innerText = 'Connecting via Proxy...';
    statusDiv.style.color = 'var(--text-muted)';

    try {
        // 1. Resolve field IDs
        statusDiv.innerText = 'Resolving Jira Fields...';
        const fieldRes = await fetch('http://localhost:8080/proxy', {
            method: 'GET',
            headers: {
                'x-target-url': `https://${domain}/rest/api/3/field`,
                'Authorization': 'Basic ' + btoa(email + ':' + token)
            }
        });
        
        if (!fieldRes.ok) {
            const errText = await fieldRes.text();
            throw new Error(`Jira Field Error (${fieldRes.status}): ${errText.substring(0, 150)}`);
        }
        
        const allFields = await fieldRes.json();

        if (!Array.isArray(allFields)) {
            console.error("Jira fields response is not an array:", allFields);
            throw new Error("Invalid Jira metadata response.");
        }

        console.log("All available Jira fields:", allFields.map(f => f.name));

        // Find field IDs
        const keyInitiativeField = allFields.find(f => f.name && f.name.toLowerCase().includes("key initiative"));
        const techSquadField = allFields.find(f => f.name && f.name.toLowerCase().includes("technology squad"));
        
        const keyInitiativeFieldId = keyInitiativeField ? keyInitiativeField.id : null;
        const techSquadFieldId = techSquadField ? techSquadField.id : null;

        console.log("Key Initiative Field:", keyInitiativeFieldId);
        console.log("Technology Squad Field:", techSquadFieldId);

        // 2. Fetch main JQL results
        statusDiv.innerText = 'Fetching Jira data...';
        console.log('üîç Running JQL Query:', jql);
        const targetUrl = `https://${domain}/rest/api/3/search/jql`;
        const fetchFields = ["summary", "assignee", "duedate", "created", "status", "project"];
        if (keyInitiativeFieldId) fetchFields.push(keyInitiativeFieldId);
        if (techSquadFieldId) fetchFields.push(techSquadFieldId);

        const payload = {
            jql: jql,
            fields: fetchFields,
            maxResults: 100
        };

        const response = await fetch('http://localhost:8080/proxy', {
            method: 'POST',
            headers: {
                'x-target-url': targetUrl,
                'Authorization': 'Basic ' + btoa(email + ':' + token),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`Proxy Error (${response.status}): ${errText.substring(0, 150)}`);
        }

        const data = await response.json();
        console.log('üìä JIRA Response:', {
            total: data.total,
            issueCount: data.issues ? data.issues.length : 0,
            maxResults: data.maxResults
        });
        
        if (!data.issues || data.issues.length === 0) {
            console.warn('‚ö†Ô∏è No issues returned from JQL query:', jql);
            statusDiv.innerText = `Warning: No issues found matching query: "${jql}"`;
            statusDiv.style.color = 'var(--warning-color)';
            return;
        }

        // 3. Fetch Key Initiatives using specific JQL
        statusDiv.innerText = 'Identifying Key Initiatives...';
        const keyInitiativeJQL = 'project in ("IT Portfolio") and "Technology Squad[Dropdown]" in ("Platform Development & Integration") and "Key Initiative" is not EMPTY';
        
        const keyInitPayload = {
            jql: keyInitiativeJQL,
            fields: ["key"],
            maxResults: 500
        };

        const keyInitResponse = await fetch('http://localhost:8080/proxy', {
            method: 'POST',
            headers: {
                'x-target-url': targetUrl,
                'Authorization': 'Basic ' + btoa(email + ':' + token),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(keyInitPayload)
        });

        let keyInitiativeKeys = new Set();
        if (keyInitResponse.ok) {
            const keyInitData = await keyInitResponse.json();
            if (keyInitData.issues) {
                keyInitiativeKeys = new Set(keyInitData.issues.map(issue => issue.key));
                console.log("Key Initiative IDs:", Array.from(keyInitiativeKeys));
            }
        }

        // 4. Map Data
        statusDiv.innerText = 'Processing Jira data...';
        const mappedInitiatives = data.issues.map(issue => {
            const f = issue.fields;

            // Status Mapping
            let status = 'active';
            const sName = f.status ? f.status.name.toLowerCase() : '';
            if (sName.includes('done') || sName.includes('closed') || sName.includes('complete')) status = 'completed';
            else if (sName.includes('plan') || sName.includes('backlog')) status = 'planned';
            else if (sName.includes('risk') || sName.includes('block')) status = 'risk';

            // Date Logic
            const start = f.created;
            const target = f.duedate ? f.duedate : new Date(new Date(start).getTime() + 864e5 * 30).toISOString();

            // Determine if Key Initiative based on JQL results
            const isKeyInitiative = keyInitiativeKeys.has(issue.key);
            const keyInitiativeVal = isKeyInitiative ? 'Yes' : 'No';

            // Extract Technology Squad for categories
            let categories = [];
            if (techSquadFieldId && f[techSquadFieldId]) {
                const squadValue = f[techSquadFieldId];
                if (typeof squadValue === 'object' && squadValue.value) {
                    categories.push(squadValue.value);
                } else if (typeof squadValue === 'string') {
                    categories.push(squadValue);
                }
            }

            return {
                id: parseInt(issue.id, 10),
                name: f.summary,
                owner: f.assignee ? f.assignee.displayName : 'Unassigned',
                keyInitiative: keyInitiativeVal,
                status: status,
                startDate: start,
                targetDate: target,
                categories: categories,
                tags: [],
                phases: []
            };
        });

        // 5. Merge with existing data and save to database
        statusDiv.innerText = 'Merging with existing data and saving...';
        let count = 0;
        for (const jiraItem of mappedInitiatives) {
            try {
                // Fetch existing initiative from database
                const existingItem = await getInitiativeFromDB(jiraItem.id);
                
                // Merge JIRA data with existing data
                const mergedItem = mergeInitiativeData(jiraItem, existingItem);
                
                console.log(`${existingItem ? 'üîÑ Merging' : '‚ú® Creating'} initiative:`, jiraItem.id, {
                    jiraCategories: jiraItem.categories,
                    existingCategories: existingItem?.categories,
                    mergedCategories: mergedItem.categories,
                    preservedPhases: mergedItem.phases?.length || 0,
                    preservedTags: mergedItem.tags?.length || 0
                });
                
                // Save merged data
                await saveInitiativeToDB(mergedItem);
                count++;
            } catch (error) {
                console.error(`Failed to save ${jiraItem.id}:`, error);
            }
        }

        await loadState();
        
        console.log('Initiatives loaded after sync:', appState.initiatives.length);
        render(); // Render immediately to show data

        statusDiv.innerText = `Success! Synced ${count} initiatives (${keyInitiativeKeys.size} key initiatives).`;
        statusDiv.style.color = 'var(--success-color)';

        setTimeout(() => {
            closeSettings();
        }, 2000);

    } catch (err) {
        console.error(err);
        statusDiv.innerText = 'Failed: ' + err.message;
        statusDiv.style.color = 'var(--danger-color)';
        if (err.message.includes('Failed to fetch')) {
            statusDiv.innerText += ' (Is proxy.js running on port 8080?)';
        }
    }
}

            // Init
           // Production-Ready Initialization
window.addEventListener('DOMContentLoaded', async () => {
    try {
        // STEP 1: Initialize Production Mode (checks Supabase or falls back to IndexedDB)
        await initializeProduction();
        
        // STEP 2: Load data
        await loadState();
        
        // STEP 3: Initialize features
        await initRiskDetection();
        requestNotificationPermission();
        
        // STEP 4: Check and create weekly snapshot if needed
        await checkAndCreateWeeklySnapshot();
        
        // STEP 5: Update UI
        updateStorageStatus();
        
        // STEP 6: Log status
        console.log('‚úÖ Portfolio Tracker Initialized');
        console.log(`üìä Loaded ${appState.initiatives.length} initiatives`);
        console.log(`üíæ Storage: ${useSupabase ? 'Cloud (Supabase)' : 'Local (IndexedDB)'}`);
        console.log('‚ö†Ô∏è Risk detection: Active');
        console.log('üì∏ Weekly snapshot: Enabled');
        
        if (!useSupabase) {
            console.log('');
            console.log('üí° TIP: Configure Supabase credentials to enable:');
            console.log('   ‚Ä¢ Cloud storage & backup');
            console.log('   ‚Ä¢ Multi-device sync');
            console.log('   ‚Ä¢ Team collaboration');
            console.log('');
        }
        
    } catch (error) {
        console.error('‚ùå Initialization failed:', error);
        alert('Failed to initialize app: ' + error.message);
    }
    
    if (appState.initiatives.length === 0) {
        // seedData();
    }
});

// Add this to your standalone.html <script> section

// Risk Detection System
function detectRisks() {
    const now = new Date();
    const fiveDaysFromNow = new Date(now.getTime() + (5 * 24 * 60 * 60 * 1000));
    
    let autoUpdatedCount = 0;
    let warnings = [];
    
    appState.initiatives.forEach(initiative => {
        if (!initiative.phases || initiative.phases.length === 0) return;
        
        let hasOverduePhase = false;
        let hasApproachingDeadline = false;
        let overduePhases = [];
        let approachingPhases = [];
        
        initiative.phases.forEach(phase => {
            const endDate = new Date(phase.endDate);
            
            // Check if phase is overdue (past end date and not completed)
            if (endDate < now && phase.status !== 'completed') {
                hasOverduePhase = true;
                const daysOverdue = Math.ceil((now - endDate) / (1000 * 60 * 60 * 24));
                overduePhases.push({
                    name: phase.name,
                    endDate: phase.endDate,
                    daysOverdue: daysOverdue
                });
            }
            
            // Check if deadline is approaching (within 5 days and not completed)
            if (endDate >= now && endDate <= fiveDaysFromNow && phase.status !== 'completed') {
                hasApproachingDeadline = true;
                const daysUntil = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                approachingPhases.push({
                    name: phase.name,
                    endDate: phase.endDate,
                    daysUntil: daysUntil
                });
            }
        });
        
        // Auto-update to "risk" if has overdue phases
        if (hasOverduePhase && initiative.status !== 'risk' && initiative.status !== 'completed') {
            initiative.status = 'risk';
            initiative._autoRisk = true; // Mark as auto-updated
            autoUpdatedCount++;
        }
        
        // Store risk info for display
        if (hasOverduePhase || hasApproachingDeadline) {
            initiative._riskInfo = {
                hasOverduePhase,
                hasApproachingDeadline,
                overduePhases,
                approachingPhases
            };
            
            warnings.push({
                initiative: initiative,
                overduePhases: overduePhases,
                approachingPhases: approachingPhases
            });
        } else {
            delete initiative._riskInfo;
        }
    });
    
    return {
        autoUpdatedCount,
        warnings
    };
}

// Save auto-detected risks to database
async function saveRiskDetection() {
    const result = detectRisks();
    
    if (result.autoUpdatedCount > 0) {
        // Save all initiatives that were auto-updated to risk
        for (const initiative of appState.initiatives) {
            if (initiative._autoRisk) {
                try {
                    await saveInitiativeToDB(initiative);
                    delete initiative._autoRisk; // Clean up marker
                } catch (error) {
                    console.error(`Failed to save risk status for ${initiative.id}:`, error);
                }
            }
        }
        
        console.log(`‚ö†Ô∏è Auto-updated ${result.autoUpdatedCount} initiatives to "At Risk" status`);
    }
    
    return result;
}

// Show risk notifications
function showRiskNotifications(warnings) {
    if (warnings.length === 0) return;
    
    let overdueCount = warnings.filter(w => w.overduePhases.length > 0).length;
    let approachingCount = warnings.filter(w => w.approachingPhases.length > 0).length;
    
    if (overdueCount > 0 || approachingCount > 0) {
        let message = '‚ö†Ô∏è DEADLINE ALERTS:\n\n';
        
        if (overdueCount > 0) {
            message += `üö® ${overdueCount} initiative(s) with OVERDUE phases\n`;
        }
        if (approachingCount > 0) {
            message += `‚è∞ ${approachingCount} initiative(s) with deadlines in next 5 days\n`;
        }
        
        message += '\nCheck Dashboard for details.';
        
        // Show browser notification if permitted
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("Portfolio Tracker Alert", {
                body: message,
                icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>‚ö†Ô∏è</text></svg>"
            });
        }
        
        // Show in-app alert (can be customized to a banner)
        console.warn(message);
    }
}

// Add visual indicators to table rows
function addRiskIndicators() {
    // This is called during render() to add visual warnings
    const tbody = document.getElementById('table-body');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        const initiative = appState.initiatives.find(i => {
            // Match by initiative name or ID in the row
            return row.textContent.includes(i.id);
        });
        
        if (initiative && initiative._riskInfo) {
            // Add warning badge
            const ownerCell = row.cells[2]; // Owner column
            if (ownerCell && !ownerCell.querySelector('.risk-badge')) {
                const badge = document.createElement('span');
                badge.className = 'risk-badge';
                badge.style.cssText = `
                    display: inline-block;
                    margin-left: 8px;
                    padding: 2px 6px;
                    background: #fef3c7;
                    color: #92400e;
                    border: 1px solid #f59e0b;
                    border-radius: 4px;
                    font-size: 0.7rem;
                    font-weight: bold;
                `;
                
                if (initiative._riskInfo.hasOverduePhase) {
                    badge.textContent = `üö® ${initiative._riskInfo.overduePhases.length} Overdue`;
                    badge.style.background = '#fee2e2';
                    badge.style.color = '#dc2626';
                    badge.style.borderColor = '#ef4444';
                } else if (initiative._riskInfo.hasApproachingDeadline) {
                    badge.textContent = `‚è∞ ${initiative._riskInfo.approachingPhases.length} Due Soon`;
                }
                
                ownerCell.appendChild(badge);
            }
            
            // Highlight row
            if (initiative._riskInfo.hasOverduePhase) {
                row.style.background = 'linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%)';
                row.style.borderLeft = '4px solid #ef4444';
            } else if (initiative._riskInfo.hasApproachingDeadline) {
                row.style.background = 'linear-gradient(90deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%)';
                row.style.borderLeft = '4px solid #f59e0b';
            }
        }
    });
}

// Add to timeline bars
function addTimelineRiskIndicators() {
    // Called during renderTimeline to add visual warnings to phase bars
    const container = document.getElementById('timeline-rows');
    if (!container) return;
    
    const now = new Date();
    const fiveDaysFromNow = new Date(now.getTime() + (5 * 24 * 60 * 60 * 1000));
    
    container.querySelectorAll('.timeline-bar').forEach(bar => {
        // Skip if no phase data (might be initiative bar, not phase bar)
        if (!bar.dataset.phaseEndDate) return;
        
        const phaseStatus = bar.dataset.phaseStatus;
        const endDate = new Date(bar.dataset.phaseEndDate);
        const phaseName = bar.dataset.phaseName || bar.textContent.trim();
        
        // Only flag phases that are NOT completed
        const isNotCompleted = phaseStatus !== 'completed';
        
        // Add warning indicator for overdue phases (past due date and not completed)
        if (endDate < now && isNotCompleted) {
            bar.style.border = '2px solid #ef4444';
            bar.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.5)';
            bar.style.position = 'relative';
            
            // Add pulsing animation
            bar.style.animation = 'pulse 2s infinite';
            
            // Calculate days overdue
            const daysOverdue = Math.ceil((now - endDate) / (1000 * 60 * 60 * 24));
            
            // Add overdue badge
            const badge = document.createElement('div');
            badge.textContent = 'üö®';
            badge.title = `OVERDUE by ${daysOverdue} day${daysOverdue !== 1 ? 's' : ''}! Phase: ${phaseName}`;
            badge.style.cssText = `
                position: absolute;
                right: 4px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 0.8rem;
                z-index: 10;
                cursor: help;
            `;
            bar.appendChild(badge);
            
            console.log(`‚ö†Ô∏è OVERDUE PHASE: "${phaseName}" - ${daysOverdue} days overdue (Status: ${phaseStatus})`);
        }
        // Add warning for approaching deadline (within 5 days and not completed)
        else if (endDate <= fiveDaysFromNow && isNotCompleted) {
            bar.style.border = '2px solid #f59e0b';
            bar.style.boxShadow = '0 0 8px rgba(245, 158, 11, 0.4)';
            bar.style.position = 'relative';
            
            // Calculate days remaining
            const daysRemaining = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            
            // Add warning badge
            const badge = document.createElement('div');
            badge.textContent = '‚è∞';
            badge.title = `Due in ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}! Phase: ${phaseName}`;
            badge.style.cssText = `
                position: absolute;
                right: 4px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 0.8rem;
                z-index: 10;
                cursor: help;
            `;
            bar.appendChild(badge);
            
            console.log(`‚è∞ APPROACHING DEADLINE: "${phaseName}" - ${daysRemaining} days remaining (Status: ${phaseStatus})`);
        }
    });
}

// Run risk detection on page load and periodically
async function initRiskDetection() {
    // Run immediately
    const result = await saveRiskDetection();
    await loadState();
    showRiskNotifications(result.warnings);
    
    // Run every 5 minutes
    setInterval(async () => {
        const result = await saveRiskDetection();
        await loadState();
        showRiskNotifications(result.warnings);
    }, 5 * 60 * 1000);
}

// Request notification permission
function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }
}

// Add pulse and shake animation CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
        20%, 40%, 60%, 80% { transform: translateX(2px); }
    }
    
    .phase-overdue {
        background: rgba(239, 68, 68, 0.05) !important;
        border-left: 4px solid var(--danger-color) !important;
        animation: shake 0.5s ease-in-out;
    }
    
    .phase-overdue:hover {
        background: rgba(239, 68, 68, 0.1) !important;
    }
    
    .phase-overdue td {
        border-top: 2px solid var(--danger-color);
        border-bottom: 2px solid var(--danger-color);
    }
    
    .phase-overdue td:first-child {
        border-left: none; /* Already has left border on tr */
    }
    
    .phase-overdue td:last-child {
        border-right: 2px solid var(--danger-color);
    }
    
    .phase-overdue input,
    .phase-overdue select {
        border-color: var(--danger-color) !important;
    }
`;
document.head.appendChild(style);

// INTEGRATE INTO EXISTING CODE:
// 1. Call initRiskDetection() on page load (add to your DOMContentLoaded handler)
// 2. Call addRiskIndicators() at the end of your render() function
// 3. Call addTimelineRiskIndicators() at the end of renderTimeline() function
// 4. Call requestNotificationPermission() on first user interaction
            
        </script>
    </div>
    </div>
</body>

</html>
